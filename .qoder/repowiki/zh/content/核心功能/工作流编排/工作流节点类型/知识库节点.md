# 知识库节点

<cite>
**本文档引用的文件**
- [rag_strategy_factory.py](file://core/knowledge/service/rag_strategy_factory.py)
- [aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py)
- [cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py)
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py)
- [sparkdesk_strategy.py](file://core/knowledge/service/impl/sparkdesk_strategy.py)
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py)
- [api.py](file://core/knowledge/api/v1/api.py)
- [knowledge-pro-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-pro-parameter.ts)
- [knowledge-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-parameter.ts)
</cite>

## 目录
1. [引言](#引言)
2. [知识库节点与核心知识服务集成](#知识库节点与核心知识服务集成)
3. [AIUI、CBG和Ragflow策略调用机制](#aiui、cbg和ragflow策略调用机制)
4. [节点配置参数详解](#节点配置参数详解)
5. [前端组件实现](#前端组件实现)
6. [知识库查询请求/响应示例](#知识库查询请求/响应示例)
7. [降级策略与错误处理](#降级策略与错误处理)
8. [结论](#结论)

## 引言

知识库节点是工作流中的关键组件，用于实现基于知识库的检索增强生成（RAG）功能。该节点通过集成核心知识服务（core/knowledge/）提供强大的知识检索能力，支持AIUI、CBG和Ragflow三种不同的策略。本文档详细说明了知识库节点的架构、配置参数、前端实现以及错误处理机制。

**Section sources**
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py#L1-L87)

## 知识库节点与核心知识服务集成

知识库节点通过策略模式与核心知识服务进行集成。系统采用工厂模式（RAGStrategyFactory）根据配置的ragType创建相应的策略实例，实现了不同知识库服务的无缝切换。

```mermaid
classDiagram
class RAGStrategy {
<<abstract>>
+query(query, doc_ids, repo_ids, top_k, threshold, **kwargs) Dict[str, Any]
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff, **kwargs) List[Dict[str, Any]]
+chunks_save(docId, group, uid, chunks, **kwargs) Any
+chunks_update(docId, group, uid, chunks, **kwargs) Any
+chunks_delete(docId, chunkIds, **kwargs) Any
+query_doc(docId, **kwargs) List[dict]
+query_doc_name(docId, **kwargs) Optional[dict]
}
class RAGStrategyFactory {
-_strategies : Dict[str, Type[RAGStrategy]]
+get_strategy(ragType : str) RAGStrategy
+register_strategy(ragType : str, strategy_class : Type[RAGStrategy]) None
}
class AIUIRAGStrategy {
+query(query, doc_ids, repo_ids, top_k, threshold, **kwargs) Dict[str, Any]
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff, **kwargs) List[Dict[str, Any]]
+chunks_save(docId, group, uid, chunks, **kwargs) Any
+chunks_update(docId, group, uid, chunks, **kwargs) Any
+chunks_delete(docId, chunkIds, **kwargs) Any
+query_doc(docId, **kwargs) List[dict]
+query_doc_name(docId, **kwargs) Optional[dict]
}
class CBGRAGStrategy {
+query(query, doc_ids, repo_ids, top_k, threshold, **kwargs) Dict[str, Any]
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff, **kwargs) List[Dict[str, Any]]
+chunks_save(docId, group, uid, chunks, **kwargs) Any
+chunks_update(docId, group, uid, chunks, **kwargs) Any
+chunks_delete(docId, chunkIds, **kwargs) Any
+query_doc(docId, **kwargs) List[dict]
+query_doc_name(docId, **kwargs) Optional[dict]
}
class RagflowRAGStrategy {
+query(query, doc_ids, repo_ids, top_k, threshold, **kwargs) Dict[str, Any]
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff, **kwargs) List[Dict[str, Any]]
+chunks_save(docId, group, uid, chunks, **kwargs) Any
+chunks_update(docId, group, uid, chunks, **kwargs) Any
+chunks_delete(docId, chunkIds, **kwargs) Any
+query_doc(docId, **kwargs) List[dict]
+query_doc_name(docId, **kwargs) Optional[dict]
}
class SparkDeskRAGStrategy {
+query(query, doc_ids, repo_ids, top_k, threshold, **kwargs) Dict[str, Any]
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff, **kwargs) List[Dict[str, Any]]
+chunks_save(docId, group, uid, chunks, **kwargs) Any
+chunks_update(docId, group, uid, chunks, **kwargs) Any
+chunks_delete(docId, chunkIds, **kwargs) Any
+query_doc(docId, **kwargs) List[dict]
+query_doc_name(docId, **kwargs) Optional[dict]
}
RAGStrategyFactory --> RAGStrategy : "创建"
RAGStrategy <|-- AIUIRAGStrategy : "实现"
RAGStrategy <|-- CBGRAGStrategy : "实现"
RAGStrategy <|-- RagflowRAGStrategy : "实现"
RAGStrategy <|-- SparkDeskRAGStrategy : "实现"
```

**Diagram sources**
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py#L1-L87)
- [rag_strategy_factory.py](file://core/knowledge/service/rag_strategy_factory.py#L1-L95)

**Section sources**
- [rag_strategy_factory.py](file://core/knowledge/service/rag_strategy_factory.py#L1-L95)

## AIUI、CBG和Ragflow策略调用机制

### AIUI策略调用机制

AIUI策略通过AIUI接口实现知识检索功能。该策略支持完整的知识库操作，包括查询、分块、保存、更新和删除等。

```mermaid
sequenceDiagram
participant 前端 as 前端组件
participant API as 知识库API
participant 工厂 as RAG策略工厂
participant AIUI策略 as AIUIRAGStrategy
participant AIUI服务 as AIUI服务
前端->>API : 发送查询请求
API->>工厂 : get_strategy("AIUI-RAG2")
工厂-->>API : 返回AIUIRAGStrategy实例
API->>AIUI策略 : query()
AIUI策略->>AIUI服务 : chunk_query()
AIUI服务-->>AIUI策略 : 返回查询结果
AIUI策略-->>API : 处理并返回结果
API-->>前端 : 返回最终结果
```

**Diagram sources**
- [aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py#L1-L270)
- [api.py](file://core/knowledge/api/v1/api.py#L1-L479)

### CBG策略调用机制

CBG策略基于星火大模型实现知识检索功能。该策略通过星火接口进行文档分块和检索，支持top-k搜索和相似度阈值过滤。

```mermaid
sequenceDiagram
participant 前端 as 前端组件
participant API as 知识库API
participant 工厂 as RAG策略工厂
participant CBG策略 as CBGRAGStrategy
participant 星火服务 as 星火服务
前端->>API : 发送查询请求
API->>工厂 : get_strategy("CBG-RAG")
工厂-->>API : 返回CBGRAGStrategy实例
API->>CBG策略 : query()
CBG策略->>星火服务 : new_topk_search()
星火服务-->>CBG策略 : 返回搜索结果
CBG策略-->>API : 处理并返回结果
API-->>前端 : 返回最终结果
```

**Diagram sources**
- [cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py#L1-L375)
- [api.py](file://core/knowledge/api/v1/api.py#L1-L479)

### Ragflow策略调用机制

Ragflow策略通过Ragflow服务实现知识管理功能。该策略支持完整的文档处理流程，包括上传、解析、分块和检索。

```mermaid
sequenceDiagram
participant 前端 as 前端组件
participant API as 知识库API
participant 工厂 as RAG策略工厂
participant Ragflow策略 as RagflowRAGStrategy
participant Ragflow服务 as Ragflow服务
前端->>API : 发送查询请求
API->>工厂 : get_strategy("Ragflow-RAG")
工厂-->>API : 返回RagflowRAGStrategy实例
API->>Ragflow策略 : query()
Ragflow策略->>Ragflow服务 : retrieval_with_dataset()
Ragflow服务-->>Ragflow策略 : 返回检索结果
Ragflow策略-->>API : 处理并返回结果
API-->>前端 : 返回最终结果
```

**Diagram sources**
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py#L1-L1016)
- [api.py](file://core/knowledge/api/v1/api.py#L1-L479)

**Section sources**
- [aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py#L1-L270)
- [cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py#L1-L375)
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py#L1-L1016)

## 节点配置参数详解

知识库节点提供了丰富的配置参数，用于控制检索行为和结果。

### 知识库选择

知识库选择参数用于指定要检索的知识库。用户可以从已创建的知识库列表中选择一个或多个知识库进行检索。

### 检索模式

系统支持两种检索模式：

- **精确检索**：使用严格的匹配算法，返回与查询内容高度相关的知识片段
- **模糊检索**：使用相似度算法，返回与查询内容语义相关的知识片段

### 返回结果数量

返回结果数量（Top K）参数控制返回的知识片段数量。该参数在不同策略中有不同的默认值：

- AIUI策略：默认返回6个结果
- CBG策略：可配置，无默认值
- Ragflow策略：默认返回6个结果

```mermaid
flowchart TD
Start([开始]) --> Config["配置参数"]
Config --> KnowledgeBase{"知识库选择"}
KnowledgeBase --> |单个知识库| Single["限制检索范围"]
KnowledgeBase --> |多个知识库| Multiple["跨知识库检索"]
Config --> RetrievalMode{"检索模式"}
RetrievalMode --> |精确| Exact["使用精确匹配算法"]
RetrievalMode --> |模糊| Fuzzy["使用相似度算法"]
Config --> ResultCount["返回结果数量"]
ResultCount --> Validate{"数量有效性验证"}
Validate --> |有效| Process["执行检索"]
Validate --> |无效| Error["返回错误"]
Process --> End([结束])
```

**Diagram sources**
- [knowledge-pro-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-pro-parameter.ts#L1-L12)
- [knowledge-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-parameter.ts#L1-L6)

**Section sources**
- [knowledge-pro-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-pro-parameter.ts#L1-L12)
- [knowledge-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-parameter.ts#L1-L6)

## 前端组件实现

前端组件实现了知识库的搜索、选择和参数配置功能。

### 知识库搜索与选择

前端通过`useKnowledgeSelect` Hook实现知识库的选择功能，支持点击外部区域关闭选择框的交互。

```mermaid
classDiagram
class KnowledgeProParameterModalInfo {
+open : boolean
+nodeId : string
}
class KnowledgeProRepoConfig {
+repoTopK? : number
+score? : number
}
class RepoConfig {
+topN? : number
+score? : number
}
class useKnowledgeSelect {
+open : boolean
+setOpen(open : boolean) : void
+knowledgeSelectRef : RefObject<HTMLDivElement>
}
useKnowledgeSelect --> KnowledgeProParameterModalInfo : "使用"
useKnowledgeSelect --> KnowledgeProRepoConfig : "使用"
useKnowledgeSelect --> RepoConfig : "使用"
```

**Diagram sources**
- [knowledge-pro-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-pro-parameter.ts#L1-L12)
- [knowledge-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-parameter.ts#L1-L6)
- [use-knowledge-select.ts](file://console/frontend/src/pages/resource-management/upload-page/components/hooks/use-knowledge-select.ts#L1-L32)

### 检索参数配置

前端提供了参数配置模态框，允许用户配置Top K、相似度阈值等检索参数。

**Section sources**
- [knowledge-pro-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-pro-parameter.ts#L1-L12)
- [knowledge-parameter.ts](file://console/frontend/src/components/workflow/types/modal/knowledge-parameter.ts#L1-L6)

## 知识库查询请求/响应示例

### 查询预处理

在执行查询之前，系统会对查询参数进行预处理和验证。

```mermaid
flowchart TD
Start([查询请求]) --> Validate["验证请求参数"]
Validate --> |参数有效| Process["处理查询参数"]
Validate --> |参数无效| ReturnError["返回参数错误"]
Process --> ParseLengthRange["解析lengthRange参数"]
ParseLengthRange --> |解析成功| ParseSeparator["解析separator参数"]
ParseSeparator --> |解析成功| CreateRequest["创建RAG请求"]
CreateRequest --> Execute["执行查询"]
ParseLengthRange --> |解析失败| HandleError["处理解析错误"]
ParseSeparator --> |解析失败| HandleError
HandleError --> ReturnError
Execute --> End([返回结果])
```

**Diagram sources**
- [api.py](file://core/knowledge/api/v1/api.py#L1-L479)

### 结果排序与后处理

查询结果会根据相似度分数进行排序，并进行后处理以符合标准格式。

```mermaid
sequenceDiagram
participant 策略 as RAG策略
participant 后处理 as 结果后处理器
participant 格式化 as 格式化器
participant 响应 as 响应生成器
策略->>后处理 : 返回原始结果
后处理->>后处理 : 按分数排序
后处理->>后处理 : 过滤低于阈值的结果
后处理->>格式化 : 转换为标准格式
格式化->>响应 : 生成响应对象
响应-->>策略 : 返回处理后的结果
```

**Diagram sources**
- [aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py#L1-L270)
- [cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py#L1-L375)
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py#L1-L1016)

**Section sources**
- [api.py](file://core/knowledge/api/v1/api.py#L1-L479)

## 降级策略与错误处理

### 服务不可用时的降级策略

当知识库服务不可用时，系统会执行降级策略，确保系统的基本功能可用。

```mermaid
flowchart TD
Start([知识库查询]) --> CheckService["检查服务状态"]
CheckService --> |服务可用| ExecuteQuery["执行查询"]
CheckService --> |服务不可用| ApplyFallback["应用降级策略"]
ApplyFallback --> CheckCache["检查缓存"]
CheckCache --> |缓存存在| ReturnCache["返回缓存结果"]
CheckCache --> |缓存不存在| ReturnDefault["返回默认响应"]
ExecuteQuery --> HandleResult["处理查询结果"]
HandleResult --> |成功| ReturnSuccess["返回成功结果"]
HandleResult --> |失败| ApplyFallback
ReturnSuccess --> End([结束])
ReturnCache --> End
ReturnDefault --> End
```

**Diagram sources**
- [api.py](file://core/knowledge/api/v1/api.py#L1-L479)

### 错误处理方案

系统实现了统一的错误处理机制，通过`handle_rag_operation`函数处理各种异常情况。

```mermaid
flowchart TD
Start([RAG操作]) --> Try["尝试执行操作"]
Try --> |成功| Success["记录成功指标"]
Try --> |异常| Catch["捕获异常"]
Catch --> CheckType["检查异常类型"]
CheckType --> |ProtocolParamException| HandleProtocol["处理协议参数异常"]
CheckType --> |ThirdPartyException| HandleThirdParty["处理第三方服务异常"]
CheckType --> |CustomException| HandleCustom["处理自定义异常"]
CheckType --> |其他异常| HandleUnexpected["处理意外异常"]
HandleProtocol --> RecordMetric["记录错误指标"]
HandleThirdParty --> RecordMetric
HandleCustom --> RecordMetric
HandleUnexpected --> RecordMetric
RecordMetric --> GenerateResponse["生成错误响应"]
GenerateResponse --> End([返回响应])
Success --> GenerateSuccess["生成成功响应"]
GenerateSuccess --> End
```

**Diagram sources**
- [api.py](file://core/knowledge/api/v1/api.py#L1-L479)

**Section sources**
- [api.py](file://core/knowledge/api/v1/api.py#L1-L479)

## 结论

知识库节点通过灵活的策略模式与核心知识服务集成，支持AIUI、CBG和Ragflow三种不同的检索策略。系统提供了丰富的配置参数，允许用户根据具体需求调整检索行为。前端组件实现了直观的知识库选择和参数配置界面，后端实现了完整的查询预处理、结果排序和后处理逻辑。当知识库服务不可用时，系统能够通过降级策略保证基本功能的可用性，并通过统一的错误处理机制确保系统的稳定性。