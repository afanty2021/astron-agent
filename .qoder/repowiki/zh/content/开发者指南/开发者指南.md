# 开发者指南

<cite>
**本文档中引用的文件**  
- [Makefile](file://Makefile)
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [README.md](file://README.md)
- [console/frontend/package.json](file://console/frontend/package.json)
- [console/frontend/vite.config.js](file://console/frontend/vite.config.js)
- [console/frontend/.env.development](file://console/frontend/.env.development)
- [console/backend/pom.xml](file://console/backend/pom.xml)
- [console/backend/config/checkstyle.xml](file://console/backend/config/checkstyle.xml)
- [console/backend/config/eclipse-formatter.xml](file://console/backend/config/eclipse-formatter.xml)
- [core/agent/pyproject.toml](file://core/agent/pyproject.toml)
- [core/common/pyproject.toml](file://core/common/pyproject.toml)
- [core/workflow/pyproject.toml](file://core/workflow/pyproject.toml)
- [makefiles/localci.toml](file://makefiles/localci.toml)
</cite>

## 目录
1. [本地开发环境搭建](#本地开发环境搭建)
2. [项目构建与测试流程](#项目构建与测试流程)
3. [前后端开发服务器启动](#前后端开发服务器启动)
4. [代码风格与提交规范](#代码风格与提交规范)
5. [调试技巧与测试策略](#调试技巧与测试策略)
6. [代码审查流程](#代码审查流程)
7. [常见开发任务指南](#常见开发任务指南)

## 本地开发环境搭建

本项目采用多语言微服务架构，包含Java、TypeScript、Python和Go等多种技术栈。为确保开发环境的一致性，建议使用Makefile进行自动化环境配置。

### 依赖安装

项目需要以下基础依赖：

- **Java 21+**：用于后端服务开发
- **Node.js 18+**：用于前端开发
- **Python 3.9+**：用于核心服务开发
- **Go 1.21+**：用于租户服务开发
- **Docker & Docker Compose**：用于容器化服务
- **Git**：用于版本控制

### 一键式环境配置

项目提供智能的Makefile命令，可自动检测项目结构并配置开发环境：

```bash
make setup
```

该命令会自动执行以下操作：
- 安装各语言栈所需的开发工具
- 配置Git hooks以确保代码质量
- 设置分支命名规范
- 安装所有模块的依赖

### 手动环境配置

如果需要手动配置特定组件，可使用以下命令：

```bash
# 安装开发工具
make install-tools

# 检查工具安装状态
make check-tools

# 安装Git hooks
make hooks-install
```

**本地开发环境搭建**
- [Makefile](file://Makefile#L1-L145)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L45-L100)

## 项目构建与测试流程

项目采用智能的Makefile系统，支持多语言项目的统一构建和测试流程。

### Makefile核心命令

项目提供15个核心Makefile命令，分为三个层级：

#### 日常核心命令（8个）
- `make setup`：一次性环境设置
- `make format`：代码格式化
- `make check`：质量检查
- `make test`：运行测试
- `make build`：构建项目
- `make push`：安全推送
- `make clean`：清理构建产物
- `make status`：显示项目状态

#### 专业命令（5个）
- `make info`：显示工具和依赖信息
- `make lint`：代码linting
- `make fix`：自动修复代码问题
- `make ci`：完整CI流水线
- `make hooks`：Git hooks管理

#### 高级命令（2个）
- `make enable-legacy`：启用完整的传统命令集

### 构建流程

使用Makefile进行项目构建：

```bash
# 格式化所有代码
make format

# 运行质量检查
make check

# 运行测试
make test

# 构建所有项目
make build

# 安全推送（包含预检查）
make push
```

这些命令会智能检测活跃项目并执行相应操作，支持多项目环境。

**项目构建与测试流程**
- [Makefile](file://Makefile#L1-L145)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L200-L250)

## 前后端开发服务器启动

### 前端开发服务器

前端项目位于`console/frontend`目录，使用Vite作为开发服务器。

启动前端开发服务器：
```bash
cd console/frontend
npm run dev
```

或使用Makefile：
```bash
make frontend-dev
```

前端服务默认在`http://localhost:3000`启动，配置文件位于`vite.config.js`，包含代理设置以连接后端API。

### 后端开发服务器

后端项目包含多个微服务，主要使用Java Spring Boot和Python FastAPI。

#### Java后端服务
位于`console/backend`目录，使用Maven管理：
```bash
cd console/backend
mvn spring-boot:run
```

#### Python核心服务
位于`core/`目录下的各个子模块，如`core/agent`：
```bash
cd core/agent
uvicorn main:app --reload
```

### 环境变量配置

前端环境变量配置文件：
- `.env.development`：开发环境
- `.env.production`：生产环境
- `.env.test`：测试环境

关键环境变量包括：
- `CONSOLE_CASDOOR_URL`：认证服务URL
- `VITE_BASE_URL`：API基础URL

**前后端开发服务器启动**
- [console/frontend/package.json](file://console/frontend/package.json#L1-L137)
- [console/frontend/vite.config.js](file://console/frontend/vite.config.js#L1-L98)
- [console/frontend/.env.development](file://console/frontend/.env.development#L1-L7)
- [console/backend/pom.xml](file://console/backend/pom.xml#L1-L344)

## 代码风格与提交规范

### 多语言代码质量标准

项目支持多种编程语言，采用统一的质量标准：

| 语言 | 格式化工具 | 质量检查工具 | 标准 |
|------|------------|---------------|------|
| **Go** | gofmt + goimports + gofumpt | golangci-lint + staticcheck | Go标准格式，复杂度≤10 |
| **Java** | Spotless (Google Java Format) | Checkstyle + PMD + SpotBugs | Google Java风格，复杂度≤10 |
| **Python** | black + isort | flake8 + mypy + pylint | PEP 8，复杂度≤10 |
| **TypeScript** | prettier | eslint + tsc | ESLint规则，严格类型检查 |

### Java代码风格配置

Java后端使用Google Java Format，配置文件位于`console/backend/config/eclipse-formatter.xml`。

关键代码质量要求：
- 行长度限制：240字符
- 方法长度限制：100行
- 参数数量限制：10个
- 循环复杂度限制：20

Checkstyle配置位于`console/backend/config/checkstyle.xml`。

### Python代码风格配置

Python项目使用`pyproject.toml`进行配置，主要工具包括：
- **Black**：代码格式化
- **isort**：导入排序
- **mypy**：静态类型检查
- **pylint**：代码分析

配置示例（`core/agent/pyproject.toml`）：
- 行长度：88字符
- 目标Python版本：3.9, 3.10, 3.11
- 复杂度限制：最多7个参数，15个局部变量，6个返回语句

### 提交信息格式

遵循Conventional Commits规范：

```
<类型>(<范围>): <描述>

[可选正文]

[可选页脚]
```

**类型**：
- `feat`：新功能
- `fix`：bug修复
- `docs`：文档更新
- `style`：代码格式化
- `refactor`：代码重构
- `test`：测试相关变更
- `chore`：构建工具、依赖更新

**代码风格与提交规范**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L250-L350)
- [console/backend/config/checkstyle.xml](file://console/backend/config/checkstyle.xml#L1-L31)
- [console/backend/config/eclipse-formatter.xml](file://console/backend/config/eclipse-formatter.xml#L1-L338)
- [core/agent/pyproject.toml](file://core/agent/pyproject.toml#L1-L228)
- [core/common/pyproject.toml](file://core/common/pyproject.toml#L1-L54)
- [core/workflow/pyproject.toml](file://core/workflow/pyproject.toml#L1-L106)

## 调试技巧与测试策略

### 测试结构

项目采用分层测试策略：
- **单元测试**：测试单个组件的隔离
- **集成测试**：测试组件间的交互
- **端到端测试**：测试完整的用户工作流

### 测试执行

使用Makefile运行测试：
```bash
# 运行所有测试
make test

# 运行特定语言的测试
make test-go
make test-java  
make test-python
make test-typescript

# 运行带覆盖率的测试
make test-coverage
```

### 测试要求

- 所有新功能必须包含测试
- bug修复必须包含回归测试
- 测试覆盖率不应降低
- 测试必须是确定性的且快速

### 调试技巧

1. **前端调试**：
   - 使用浏览器开发者工具
   - 利用Vite的热重载功能
   - 检查网络请求和响应

2. **后端调试**：
   - 使用IDE的调试器
   - 查看日志输出
   - 使用Postman等工具测试API

3. **微服务调试**：
   - 使用分布式追踪
   - 检查服务间的通信
   - 监控服务健康状态

**调试技巧与测试策略**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L350-L400)
- [core/agent/pyproject.toml](file://core/agent/pyproject.toml#L1-L228)

## 代码审查流程

### 自动化检查

所有Pull Request必须通过自动化质量检查，包括：
- 代码格式化检查
- 静态代码分析
- 单元测试和集成测试
- 覆盖率检查

### 代码审查要点

1. **功能正确性**：
   - 是否解决了预期问题
   - 是否引入了新的bug
   - 边界条件是否处理

2. **代码质量**：
   - 是否遵循代码风格指南
   - 复杂度是否合理
   - 是否有重复代码

3. **可维护性**：
   - 代码是否易于理解
   - 是否有足够的注释
   - 是否遵循设计原则

4. **性能影响**：
   - 是否有性能瓶颈
   - 数据库查询是否优化
   - 内存使用是否合理

### 审查流程

1. **自动化检查**：PR必须通过所有CI检查
2. **代码审查**：至少一名维护者必须批准
3. **测试验证**：所有测试必须通过
4. **文档更新**：文档必须相应更新

**代码审查流程**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L350-L400)

## 常见开发任务指南

### 添加新功能

1. **创建功能分支**：
   ```bash
   make new-feature name=feature-name
   ```

2. **实现功能**：
   - 遵循代码风格指南
   - 编写必要的测试
   - 更新相关文档

3. **提交代码**：
   - 确保代码格式化
   - 通过质量检查
   - 编写符合规范的提交信息

4. **创建Pull Request**：
   - 使用PR模板
   - 描述变更内容
   - 指定审查人员

### 修复bug

1. **创建bug修复分支**：
   ```bash
   make new-bugfix name=issue-name
   ```

2. **定位问题**：
   - 复现bug
   - 分析日志
   - 调试代码

3. **修复问题**：
   - 编写回归测试
   - 实现修复
   - 验证修复效果

4. **提交修复**：
   - 确保不引入新问题
   - 更新文档（如需要）
   - 提交PR

### 分支管理

遵循分支命名规范：
- 功能分支：`feature/feature-name`
- bug修复：`bugfix/issue-name`
- 紧急修复：`hotfix/patch-name`
- 文档更新：`doc/doc-name`

**常见开发任务指南**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L150-L200)