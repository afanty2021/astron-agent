# çŸ¥è¯†åº“æœåŠ¡éƒ¨ç½²æŒ‡å—

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [core/knowledge/Dockerfile](file://core/knowledge/Dockerfile)
- [core/knowledge/main.py](file://core/knowledge/main.py)
- [core/knowledge/pyproject.toml](file://core/knowledge/pyproject.toml)
- [core/knowledge/api/v1/api.py](file://core/knowledge/api/v1/api.py)
- [core/knowledge/service/impl/ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py)
- [core/knowledge/service/impl/aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py)
- [core/knowledge/service/impl/cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py)
- [core/knowledge/infra/ragflow/ragflow_client.py](file://core/knowledge/infra/ragflow/ragflow_client.py)
- [core/knowledge/infra/aiui/aiui.py](file://core/knowledge/infra/aiui/aiui.py)
- [core/knowledge/infra/xinghuo/xinghuo.py](file://core/knowledge/infra/xinghuo/xinghuo.py)
- [core/common/otlp/metrics/meter.py](file://core/common/otlp/metrics/meter.py)
- [core/common/otlp/trace/span.py](file://core/common/otlp/trace/span.py)
</cite>

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [Dockeréƒ¨ç½²é…ç½®](#dockeréƒ¨ç½²é…ç½®)
4. [å¤–éƒ¨çŸ¥è¯†åº“ç³»ç»Ÿé›†æˆ](#å¤–éƒ¨çŸ¥è¯†åº“ç³»ç»Ÿé›†æˆ)
5. [æœåŠ¡åˆå§‹åŒ–ä¸å¥åº·æ£€æŸ¥](#æœåŠ¡åˆå§‹åŒ–ä¸å¥åº·æ£€æŸ¥)
6. [APIæ¥å£ä¸è·¯ç”±](#apiæ¥å£ä¸è·¯ç”±)
7. [æ€§èƒ½ç›‘æ§ä¸æŒ‡æ ‡](#æ€§èƒ½ç›‘æ§ä¸æŒ‡æ ‡)
8. [æ•…éšœæ’æŸ¥æŒ‡å—](#æ•…éšœæ’æŸ¥æŒ‡å—)
9. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## æ¦‚è¿°

çŸ¥è¯†åº“æœåŠ¡æ˜¯astron-agenté¡¹ç›®çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£æä¾›RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰åŠŸèƒ½ã€‚è¯¥æœåŠ¡æ”¯æŒå¤šç§å¤–éƒ¨çŸ¥è¯†åº“ç³»ç»Ÿçš„é›†æˆï¼ŒåŒ…æ‹¬RAGFlowã€AIUIå’ŒSpark LLMï¼ˆCBGï¼‰ï¼Œå¹¶é€šè¿‡ç»Ÿä¸€çš„APIæ¥å£å¯¹å¤–æä¾›æ–‡æ¡£å¤„ç†ã€çŸ¥è¯†æ£€ç´¢å’Œè¯­ä¹‰æŸ¥è¯¢èƒ½åŠ›ã€‚

### ä¸»è¦ç‰¹æ€§

- **å¤šç­–ç•¥æ”¯æŒ**ï¼šæ”¯æŒRAGFlowã€AIUIã€Spark LLMä¸‰ç§ä¸åŒçš„çŸ¥è¯†åº“ç­–ç•¥
- **å¼‚æ­¥å¤„ç†**ï¼šåŸºäºaiohttpçš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼Œæ”¯æŒé«˜å¹¶å‘è¯·æ±‚
- **åˆ†å¸ƒå¼è¿½è¸ª**ï¼šé›†æˆOpenTelemetryè¿›è¡Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
- **æ€§èƒ½ç›‘æ§**ï¼šå†…ç½®æŒ‡æ ‡æ”¶é›†å’ŒPrometheuså…¼å®¹çš„ç›‘æ§ç«¯ç‚¹
- **å®¹é”™æœºåˆ¶**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé‡è¯•é€»è¾‘

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
subgraph "å®¢æˆ·ç«¯å±‚"
Client[å®¢æˆ·ç«¯åº”ç”¨]
Agent[AgentæœåŠ¡]
end
subgraph "çŸ¥è¯†åº“æœåŠ¡"
Gateway[APIç½‘å…³]
Router[è·¯ç”±å¤„ç†å™¨]
Strategy[ç­–ç•¥å·¥å‚]
end
subgraph "ç­–ç•¥å±‚"
RAGFlow[RAGFlowç­–ç•¥]
AIUI[AIUIç­–ç•¥]
CBG[Spark LLMç­–ç•¥]
end
subgraph "å¤–éƒ¨ç³»ç»Ÿ"
RAGFlowAPI[RAGFlow API]
AIUIAPI[AIUI API]
CBGAPI[Spark LLM API]
end
subgraph "ç›‘æ§å±‚"
OTLP[OpenTelemetry]
Metrics[æŒ‡æ ‡æ”¶é›†]
Tracing[é“¾è·¯è¿½è¸ª]
end
Client --> Gateway
Agent --> Gateway
Gateway --> Router
Router --> Strategy
Strategy --> RAGFlow
Strategy --> AIUI
Strategy --> CBG
RAGFlow --> RAGFlowAPI
AIUI --> AIUIAPI
CBG --> CBGAPI
Strategy --> OTLP
OTLP --> Metrics
OTLP --> Tracing
```

**å›¾è¡¨æ¥æº**
- [core/knowledge/api/v1/api.py](file://core/knowledge/api/v1/api.py#L1-L50)
- [core/knowledge/service/impl/ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py#L1-L50)

## Dockeréƒ¨ç½²é…ç½®

### åŸºç¡€Dockerfileé…ç½®

çŸ¥è¯†åº“æœåŠ¡ä½¿ç”¨Python 3.11 Slimä½œä¸ºåŸºç¡€é•œåƒï¼Œé€šè¿‡uvåŒ…ç®¡ç†å™¨è¿›è¡Œä¾èµ–ç®¡ç†ï¼š

```dockerfile
FROM python:3.11-slim

WORKDIR /opt/core

ENV PATH=$PATH:/opt/core
ENV PYTHONPATH /opt/core
ENV UV_NO_CACHE=1

RUN pip install uv --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple/

COPY core/knowledge/pyproject.toml ./
COPY core/knowledge/uv.lock ./

RUN uv sync -i https://pypi.tuna.tsinghua.edu.cn/simple/

COPY core/common ./common
COPY core/knowledge ./knowledge

CMD ["uv", "run", "knowledge/main.py"]
```

### ç¯å¢ƒå˜é‡é…ç½®

| å˜é‡å | é»˜è®¤å€¼ | æè¿° |
|--------|--------|------|
| `SERVICE_PORT` | 20010 | æœåŠ¡ç›‘å¬ç«¯å£ |
| `WORKERS` | 1 | å·¥ä½œè¿›ç¨‹æ•°é‡ |
| `RAGFLOW_BASE_URL` | - | RAGFlowæœåŠ¡åŸºç¡€URL |
| `RAGFLOW_API_TOKEN` | - | RAGFlow APIè®¿é—®ä»¤ç‰Œ |
| `RAGFLOW_DEFAULT_GROUP` | Stellar Knowledge Base | é»˜è®¤æ•°æ®é›†åç§° |
| `RAGFLOW_TIMEOUT` | 30 | RAGFlowè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `AIUI_API_KEY` | - | AIUI APIå¯†é’¥ |
| `AIUI_API_SECRET` | - | AIUI APIå¯†é’¥ |
| `AIUI_URL_V2` | - | AIUIæœåŠ¡åœ°å€ |
| `XINGHUO_APP_ID` | - | æ˜Ÿç«è®¤çŸ¥å¤§æ¨¡å‹APP ID |
| `XINGHUO_APP_SECRET` | - | æ˜Ÿç«è®¤çŸ¥å¤§æ¨¡å‹å¯†é’¥ |
| `XINGHUO_RAG_URL` | - | æ˜Ÿç«RAGæœåŠ¡åœ°å€ |

### éƒ¨ç½²å‘½ä»¤

```bash
# æ„å»ºé•œåƒ
docker build -t astron-knowledge:latest -f core/knowledge/Dockerfile .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name astron-knowledge \
  -p 20010:20010 \
  -e SERVICE_PORT=20010 \
  -e WORKERS=4 \
  -e RAGFLOW_BASE_URL=https://ragflow.example.com \
  -e RAGFLOW_API_TOKEN=your_api_token \
  -e AIUI_API_KEY=your_aiui_key \
  -e AIUI_API_SECRET=your_aiui_secret \
  -e XINGHUO_APP_ID=your_app_id \
  -e XINGHUO_APP_SECRET=your_app_secret \
  astron-knowledge:latest
```

**ç« èŠ‚æ¥æº**
- [core/knowledge/Dockerfile](file://core/knowledge/Dockerfile#L1-L19)
- [core/knowledge/main.py](file://core/knowledge/main.py#L95-L113)

## å¤–éƒ¨çŸ¥è¯†åº“ç³»ç»Ÿé›†æˆ

### RAGFlowé›†æˆé…ç½®

RAGFlowæ˜¯ä¸»è¦çš„çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿï¼Œæä¾›äº†å®Œæ•´çš„æ–‡æ¡£å¤„ç†å’Œå‘é‡æ£€ç´¢åŠŸèƒ½ã€‚

#### è¿æ¥é…ç½®

```python
# RAGFlowå®¢æˆ·ç«¯é…ç½®
base_url = os.getenv("RAGFLOW_BASE_URL", "")
api_key = os.getenv("RAGFLOW_API_TOKEN", "")
timeout = int(os.getenv("RAGFLOW_TIMEOUT", "30"))
default_group = os.getenv("RAGFLOW_DEFAULT_GROUP", "Stellar Knowledge Base")
```

#### æ ¸å¿ƒåŠŸèƒ½å®ç°

RAGFlowç­–ç•¥å®ç°äº†å®Œæ•´çš„RAGæ“ä½œæµç¨‹ï¼š

1. **æ–‡æ¡£è§£æ**ï¼šæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼çš„è‡ªåŠ¨è§£æ
2. **å‘é‡åŒ–å¤„ç†**ï¼šè‡ªåŠ¨ç”Ÿæˆæ–‡æœ¬å‘é‡è¡¨ç¤º
3. **ç›¸ä¼¼åº¦æ£€ç´¢**ï¼šåŸºäºå‘é‡çš„è¯­ä¹‰æœç´¢
4. **å¢é‡æ›´æ–°**ï¼šæ”¯æŒæ–‡æ¡£çš„å¢é‡ä¿®æ”¹

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯
participant Strategy as RAGFlowç­–ç•¥
participant Client as RAGFlowå®¢æˆ·ç«¯
participant API as RAGFlow API
Client->>Strategy : æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
Strategy->>Client : åˆ›å»ºæ•°æ®é›†
Client->>API : ä¸Šä¼ æ–‡æ¡£
API-->>Client : æ–‡æ¡£ID
Client->>API : è§¦å‘è§£æ
API-->>Client : è§£æçŠ¶æ€
Client->>API : æŸ¥è¯¢ç»“æœ
API-->>Client : æ£€ç´¢ç»“æœ
Client-->>Strategy : æ ¼å¼åŒ–å“åº”
Strategy-->>Client : æœ€ç»ˆç»“æœ
```

**å›¾è¡¨æ¥æº**
- [core/knowledge/service/impl/ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py#L150-L250)
- [core/knowledge/infra/ragflow/ragflow_client.py](file://core/knowledge/infra/ragflow/ragflow_client.py#L400-L500)

### AIUIé›†æˆé…ç½®

AIUIæä¾›äº†ä¸“ä¸šçš„æ–‡æ¡£ç†è§£å’Œè¯­ä¹‰æ£€ç´¢èƒ½åŠ›ã€‚

#### è®¤è¯æœºåˆ¶

AIUIé‡‡ç”¨åŸºäºHMAC-SHA256çš„ç­¾åè®¤è¯ï¼š

```python
async def assemble_auth_url(request_path: str, method: str = "POST") -> str:
    api_key = os.getenv("AIUI_API_KEY", "")
    api_secret = os.getenv("AIUI_API_SECRET", "")
    request_url = os.getenv("AIUI_URL_V2", "") + request_path
    
    # ç”Ÿæˆç­¾å
    signature_origin = f"host: {host}\ndate: {date}\n{method} {path} HTTP/1.1"
    signature_bytes = hmac.new(
        api_secret.encode("utf-8"),
        signature_origin.encode("utf-8"),
        digestmod=hashlib.sha256,
    ).digest()
```

#### æ”¯æŒçš„æ“ä½œç±»å‹

| æ“ä½œç±»å‹ | åŠŸèƒ½æè¿° | å‚æ•°è¦æ±‚ |
|----------|----------|----------|
| `chunk_query` | è¯­ä¹‰æŸ¥è¯¢ | query, doc_ids, top_k, threshold |
| `document_parse` | æ–‡æ¡£è§£æ | file_url, resource_type |
| `chunk_split` | æ–‡æœ¬åˆ‡åˆ† | document, length_range, overlap |
| `chunk_save` | å—ä¿å­˜ | doc_id, group, chunks |
| `chunk_delete` | å—åˆ é™¤ | doc_id, chunk_ids |

### Spark LLMï¼ˆCBGï¼‰é›†æˆ

æ˜Ÿç«è®¤çŸ¥å¤§æ¨¡å‹æä¾›äº†å¼ºå¤§çš„è¯­è¨€ç†è§£å’ŒçŸ¥è¯†æ£€ç´¢èƒ½åŠ›ã€‚

#### è®¤è¯æµç¨‹

```python
async def assemble_spark_auth_headers_async() -> Dict[str, str]:
    timestamp = int(time.time())
    signature = get_signature(
        os.getenv("XINGHUO_APP_ID", ""), 
        timestamp, 
        os.getenv("XINGHUO_APP_SECRET", "")
    )
    
    return {
        "Accept": "application/json",
        "appId": os.getenv("XINGHUO_APP_ID", ""),
        "timestamp": str(timestamp),
        "signature": signature,
    }
```

#### æ ¸å¿ƒåŠŸèƒ½

- **æ··åˆæ£€ç´¢**ï¼šç»“åˆå…³é”®è¯å’Œè¯­ä¹‰çš„åŒé‡æ£€ç´¢
- **å®æ—¶å¤„ç†**ï¼šæ”¯æŒåœ¨çº¿æ–‡æ¡£çš„å®æ—¶è§£æ
- **æ™ºèƒ½åˆ‡åˆ†**ï¼šåŸºäºå†…å®¹ç»“æ„çš„æ™ºèƒ½æ–‡æœ¬åˆ†å‰²

**ç« èŠ‚æ¥æº**
- [core/knowledge/service/impl/ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py#L1-L100)
- [core/knowledge/service/impl/aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py#L1-L50)
- [core/knowledge/service/impl/cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py#L1-L50)

## æœåŠ¡åˆå§‹åŒ–ä¸å¥åº·æ£€æŸ¥

### åˆå§‹åŒ–æµç¨‹

æœåŠ¡å¯åŠ¨æ—¶æ‰§è¡Œä»¥ä¸‹åˆå§‹åŒ–æ­¥éª¤ï¼š

```mermaid
flowchart TD
Start([æœåŠ¡å¯åŠ¨]) --> LoadEnv[åŠ è½½ç¯å¢ƒå˜é‡]
LoadEnv --> InitServices[åˆå§‹åŒ–æœåŠ¡]
InitServices --> ConfigOTLP[é…ç½®OTLPç›‘æ§]
ConfigOTLP --> CreateApp[åˆ›å»ºFastAPIåº”ç”¨]
CreateApp --> SetupRoutes[è®¾ç½®è·¯ç”±]
SetupRoutes --> RegisterHandlers[æ³¨å†Œå¼‚å¸¸å¤„ç†å™¨]
RegisterHandlers --> HealthCheck[å¥åº·æ£€æŸ¥é…ç½®]
HealthCheck --> StartServer[å¯åŠ¨æœåŠ¡å™¨]
StartServer --> Ready([æœåŠ¡å°±ç»ª])
```

**å›¾è¡¨æ¥æº**
- [core/knowledge/main.py](file://core/knowledge/main.py#L25-L50)

### å¼‚å¸¸å¤„ç†æœºåˆ¶

æœåŠ¡å®ç°äº†å…¨å±€å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½èƒ½å¾—åˆ°é€‚å½“çš„å“åº”ï¼š

```python
@app.exception_handler(RequestValidationError)
async def global_validation_exception_handler(
    _request: Request, exc: RequestValidationError
) -> JSONResponse:
    error_details = [
        f"field: {'.'.join(map(str, err['loc']))}, message: {err['msg']}"
        for err in exc.errors()
    ]
    error_response = ErrorResponse(
        code_enum=CodeEnum.ParameterInvalid,
        message=f"Request parameter error: {error_details}",
    )
    return JSONResponse(content=error_response.model_dump())
```

### å…³é—­é’©å­

æœåŠ¡åœ¨ä¼˜é›…å…³é—­æ—¶ä¼šæ‰§è¡Œæ¸…ç†æ“ä½œï¼š

```python
@app.on_event("shutdown")
async def shutdown() -> None:
    try:
        from knowledge.infra.ragflow import cleanup_session
        await cleanup_session()
    except Exception as e:
        logger.warning(f"Failed to cleanup RAGFlow session: {e}")
    print("ğŸ§¹ Final shutdown hook executed.")
```

**ç« èŠ‚æ¥æº**
- [core/knowledge/main.py](file://core/knowledge/main.py#L35-L85)

## APIæ¥å£ä¸è·¯ç”±

### æ ¸å¿ƒAPIç«¯ç‚¹

çŸ¥è¯†åº“æœåŠ¡æä¾›äº†å®Œæ•´çš„RESTful APIæ¥å£ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° |
|------|------|----------|----------|
| `/knowledge/v1/document/split` | POST | æ–‡ä»¶åˆ‡åˆ†å¤„ç† | fileUrl, lengthRange, overlap |
| `/knowledge/v1/document/upload` | POST | æ–‡ä»¶ä¸Šä¼ å¤„ç† | file, ragType, lengthRange |
| `/knowledge/v1/chunks/save` | POST | å—ä¿å­˜ | docId, group, chunks |
| `/knowledge/v1/chunk/update` | POST | å—æ›´æ–° | docId, group, chunks |
| `/knowledge/v1/chunk/delete` | POST | å—åˆ é™¤ | docId, chunkIds |
| `/knowledge/v1/chunk/query` | POST | è¯­ä¹‰æŸ¥è¯¢ | query, doc_ids, top_k |
| `/knowledge/v1/document/chunk` | POST | è·å–æ–‡æ¡£å— | docId |
| `/knowledge/v1/document/name` | POST | è·å–æ–‡æ¡£åç§° | docId |

### ç»Ÿä¸€å¤„ç†æœºåˆ¶

æ‰€æœ‰APIè¯·æ±‚éƒ½é€šè¿‡ç»Ÿä¸€çš„å¤„ç†å‡½æ•°è¿›è¡Œå¤„ç†ï¼Œç¡®ä¿ä¸€è‡´çš„é”™è¯¯å¤„ç†å’Œç›‘æ§ï¼š

```python
async def handle_rag_operation(
    *,
    span_context: Span,
    metric: Meter,
    operation_callable: Callable[..., Any],
    **operation_kwargs: Any,
) -> Union[SuccessDataResponse, ErrorResponse]:
    try:
        result_data = await operation_callable(**operation_kwargs, span=span_context)
        
        # è®°å½•æˆåŠŸè¾“å‡ºå’ŒæŒ‡æ ‡
        span_context.add_info_events({
            "usr_output": json.dumps(result_data, ensure_ascii=False, default=str)
        })
        metric.in_success_count()
        
        return SuccessDataResponse(data=result_data, sid=span_context.sid)
        
    except Exception as e:
        # ç»Ÿä¸€å¼‚å¸¸å¤„ç†
        error_msg = f"{operation_callable.__name__} err (Unexpected), reason {e}"
        logger.error(error_msg)
        span_context.record_exception(e)
        metric.in_error_count(code=CodeEnum.ServiceException.code)
        return ErrorResponse(
            code_enum=CodeEnum.ServiceException,
            message=f"Internal server error:{error_msg}",
        )
```

### åˆ†å¸ƒå¼è¿½è¸ª

æ¯ä¸ªAPIè¯·æ±‚éƒ½ä¼šç”Ÿæˆå”¯ä¸€çš„è·Ÿè¸ªIDï¼Œå¹¶è®°å½•è¯¦ç»†çš„æ‰§è¡Œä¿¡æ¯ï¼š

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯
participant API as APIå¤„ç†å™¨
participant Span as é“¾è·¯è¿½è¸ª
participant Service as ä¸šåŠ¡æœåŠ¡
Client->>API : HTTPè¯·æ±‚
API->>Span : åˆ›å»ºSpan
Span->>Span : è®°å½•è¾“å…¥å‚æ•°
API->>Service : è°ƒç”¨ä¸šåŠ¡é€»è¾‘
Service-->>API : è¿”å›ç»“æœ
API->>Span : è®°å½•è¾“å‡ºç»“æœ
API->>Span : è®°å½•æ€§èƒ½æŒ‡æ ‡
API-->>Client : HTTPå“åº”
```

**å›¾è¡¨æ¥æº**
- [core/knowledge/api/v1/api.py](file://core/knowledge/api/v1/api.py#L60-L120)

**ç« èŠ‚æ¥æº**
- [core/knowledge/api/v1/api.py](file://core/knowledge/api/v1/api.py#L1-L100)

## æ€§èƒ½ç›‘æ§ä¸æŒ‡æ ‡

### ç›‘æ§æŒ‡æ ‡ä½“ç³»

æœåŠ¡é›†æˆäº†OpenTelemetryè¿›è¡Œå…¨æ–¹ä½çš„æ€§èƒ½ç›‘æ§ï¼š

#### æ ¸å¿ƒæŒ‡æ ‡ç±»å‹

| æŒ‡æ ‡ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|----------|------|------|
| è®¡æ•°å™¨ | è¯·æ±‚æˆåŠŸç‡/å¤±è´¥ç‡ | `success_count`, `error_count` |
| ç›´æ–¹å›¾ | å“åº”æ—¶é—´åˆ†å¸ƒ | `response_time_histogram` |
| æ ‡ç­¾ | ç¯å¢ƒå’ŒåŠŸèƒ½æ ‡è¯† | `dc`, `server_host`, `func` |

#### æŒ‡æ ‡æ”¶é›†å®ç°

```python
class Meter:
    def in_success_count(self, lables: Optional[dict] = None, count: int = 1) -> None:
        """ä¸ŠæŠ¥æˆåŠŸæ¬¡æ•°"""
        self.in_error_count(0, lables, count)
    
    def in_error_count(self, code: int, labels: Optional[dict] = None, 
                      count: int = 1, is_in_histogram: bool = True) -> None:
        """ä¸ŠæŠ¥é”™è¯¯æ¬¡æ•°ï¼ŒåŒæ—¶è®°å½•è€—æ—¶"""
        attr = self._get_default_labels()
        attr["ret"] = code
        
        if labels:
            attr.update(labels)
            
        metric.counter.add(count, attr)
        if is_in_histogram:
            self.in_histogram(labels)
```

### åˆ†å¸ƒå¼è¿½è¸ª

æœåŠ¡ä½¿ç”¨OpenTelemetryè¿›è¡Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼š

```python
class Span:
    def add_info_events(self, attributes: Optional[types.Attributes] = None) -> None:
        """æ·»åŠ INFOçº§åˆ«äº‹ä»¶ï¼Œè®°å½•è¯¦ç»†æ‰§è¡Œä¿¡æ¯"""
        value_bytes = json.dumps(attributes, ensure_ascii=False).encode("utf-8")
        
        if len(value_bytes) >= SPAN_SIZE_LIMIT:
            # å¤§äºé™åˆ¶æ—¶å°è¯•ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
            try:
                if self.oss_service is not None:
                    trace_link = self.oss_service.upload_file(
                        f"{str(uuid.uuid4())}", value_bytes
                    )
                    attributes = {"trace_link": trace_link}
            except Exception:
                attributes = {"error": "æ—¥å¿—å†…å®¹è¿‡å¤§ï¼Œä¸Šä¼ å¤±è´¥"}
        
        self.get_otlp_span().add_event(
            SpanLevel.INFO.value, attributes=attributes
        )
```

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

æœåŠ¡æä¾›äº†æ ‡å‡†çš„å¥åº·æ£€æŸ¥æ¥å£ï¼Œæ”¯æŒPrometheusç›‘æ§ï¼š

```python
# åœ¨docker/ragflowç›®å½•ä¸­æœ‰ç›¸å…³çš„å¥åº·æ£€æŸ¥é…ç½®
# å¯ä»¥é€šè¿‡ /api/metrics è·å–Prometheusæ ¼å¼çš„æŒ‡æ ‡
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **è¿æ¥æ± ç®¡ç†**ï¼šåˆç†é…ç½®HTTPè¿æ¥æ± å¤§å°
2. **è¶…æ—¶æ§åˆ¶**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´è¯·æ±‚è¶…æ—¶æ—¶é—´
3. **é‡è¯•æœºåˆ¶**ï¼šå¯¹ä¸´æ—¶æ€§é”™è¯¯å®æ–½æŒ‡æ•°é€€é¿é‡è¯•
4. **èµ„æºç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥å†…å­˜å’ŒCPUä½¿ç”¨æƒ…å†µ

**ç« èŠ‚æ¥æº**
- [core/common/otlp/metrics/meter.py](file://core/common/otlp/metrics/meter.py#L1-L50)
- [core/common/otlp/trace/span.py](file://core/common/otlp/trace/span.py#L1-L50)

## æ•…éšœæ’æŸ¥æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­

#### 1. å¤–éƒ¨æœåŠ¡è¿æ¥é—®é¢˜

**ç—‡çŠ¶**ï¼šAPIè¯·æ±‚è¿”å›è¶…æ—¶æˆ–è¿æ¥é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
curl -I $RAGFLOW_BASE_URL/ping

# æ£€æŸ¥è®¤è¯ä¿¡æ¯
echo "API Token: $RAGFLOW_API_TOKEN"

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl -H "Authorization: Bearer $RAGFLOW_API_TOKEN" \
     $RAGFLOW_BASE_URL/api/v1/datasets
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- éªŒè¯APIå¯†é’¥çš„æœ‰æ•ˆæ€§
- æ£€æŸ¥ç½‘ç»œé˜²ç«å¢™è®¾ç½®
- ç¡®è®¤æœåŠ¡ç«¯ç‚¹çš„å¯ç”¨æ€§

#### 2. æ–‡æ¡£å¤„ç†å¤±è´¥

**ç—‡çŠ¶**ï¼šæ–‡ä»¶ä¸Šä¼ åæ— æ³•æ­£å¸¸è§£æ

**æ’æŸ¥æµç¨‹**ï¼š
```mermaid
flowchart TD
Start[æ–‡æ¡£å¤„ç†å¤±è´¥] --> CheckFormat[æ£€æŸ¥æ–‡ä»¶æ ¼å¼]
CheckFormat --> FormatOK{æ ¼å¼æ”¯æŒ?}
FormatOK --> |å¦| ConvertFormat[è½¬æ¢æ–‡ä»¶æ ¼å¼]
FormatOK --> |æ˜¯| CheckSize[æ£€æŸ¥æ–‡ä»¶å¤§å°]
CheckSize --> SizeOK{å¤§å°åˆé€‚?}
SizeOK --> |å¦| ReduceSize[å‹ç¼©æ–‡ä»¶]
SizeOK --> |æ˜¯| CheckContent[æ£€æŸ¥æ–‡ä»¶å†…å®¹]
CheckContent --> ContentOK{å†…å®¹æœ‰æ•ˆ?}
ContentOK --> |å¦| FixContent[ä¿®å¤æ–‡ä»¶å†…å®¹]
ContentOK --> |æ˜¯| CheckAPI[æ£€æŸ¥APIæœåŠ¡]
CheckAPI --> Resolved[é—®é¢˜è§£å†³]
ConvertFormat --> CheckSize
ReduceSize --> CheckContent
FixContent --> CheckAPI
```

**å›¾è¡¨æ¥æº**
- [core/knowledge/service/impl/ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py#L200-L300)

#### 3. å†…å­˜å’Œæ€§èƒ½é—®é¢˜

**ç›‘æ§æŒ‡æ ‡**ï¼š
- CPUä½¿ç”¨ç‡ > 80%
- å†…å­˜ä½¿ç”¨ç‡ > 85%
- å“åº”æ—¶é—´ > 5ç§’
- é”™è¯¯ç‡ > 5%

**ä¼˜åŒ–æªæ–½**ï¼š
```bash
# å¢åŠ å·¥ä½œè¿›ç¨‹æ•°é‡
export WORKERS=4

# è°ƒæ•´è¶…æ—¶æ—¶é—´
export RAGFLOW_TIMEOUT=60

# ç›‘æ§èµ„æºä½¿ç”¨
docker stats astron-knowledge
```

### æ—¥å¿—åˆ†æ

#### æ—¥å¿—çº§åˆ«é…ç½®

| çº§åˆ« | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| ERROR | ä¸¥é‡é”™è¯¯ | APIè°ƒç”¨å¤±è´¥ |
| WARNING | è­¦å‘Šä¿¡æ¯ | è¿æ¥é‡è¯• |
| INFO | ä¸€èˆ¬ä¿¡æ¯ | è¯·æ±‚å¤„ç†å®Œæˆ |
| DEBUG | è°ƒè¯•ä¿¡æ¯ | è¯¦ç»†æ‰§è¡Œæµç¨‹ |

#### å…³é”®æ—¥å¿—æ¨¡å¼

```bash
# æŸ¥æ‰¾é”™è¯¯æ—¥å¿—
docker logs astron-knowledge 2>&1 | grep -i error

# æŸ¥æ‰¾æ€§èƒ½é—®é¢˜
docker logs astron-knowledge | grep -E "(timeout|slow|exceed)"

# å®æ—¶ç›‘æ§
docker logs -f astron-knowledge
```

### æ•…éšœæ¢å¤ç­–ç•¥

#### è‡ªåŠ¨æ¢å¤æœºåˆ¶

1. **è¿æ¥é‡è¯•**ï¼šå¯¹ä¸´æ—¶æ€§ç½‘ç»œé”™è¯¯å®æ–½é‡è¯•
2. **é™çº§å¤„ç†**ï¼šå¤–éƒ¨æœåŠ¡ä¸å¯ç”¨æ—¶ä½¿ç”¨æœ¬åœ°ç¼“å­˜
3. **ç†”æ–­ä¿æŠ¤**ï¼šè¿ç»­å¤±è´¥æ—¶æš‚åœå¤–éƒ¨è°ƒç”¨

#### æ‰‹åŠ¨æ¢å¤æ­¥éª¤

```bash
# é‡å¯æœåŠ¡
docker restart astron-knowledge

# æ¸…ç†ä¼šè¯ç¼“å­˜
docker exec astron-knowledge python -c "
from knowledge.infra.ragflow import cleanup_session
await cleanup_session()
"

# é‡æ–°åŠ è½½é…ç½®
docker exec astron-knowledge python -c "
from knowledge.infra.ragflow import reload_config
reload_config()
"
```

**ç« èŠ‚æ¥æº**
- [core/knowledge/service/impl/ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py#L400-L500)
- [core/knowledge/infra/ragflow/ragflow_client.py](file://core/knowledge/infra/ragflow/ragflow_client.py#L600-L700)

## æœ€ä½³å®è·µ

### éƒ¨ç½²æœ€ä½³å®è·µ

#### 1. ç¯å¢ƒéš”ç¦»

```yaml
# docker-compose.yml ç¤ºä¾‹
version: '3.8'
services:
  knowledge:
    image: astron-knowledge:latest
    environment:
      - RAGFLOW_BASE_URL=https://ragflow.prod.company.com
      - RAGFLOW_API_TOKEN_FILE=/run/secrets/ragflow_token
      - AIUI_API_KEY_FILE=/run/secrets/aiui_key
    secrets:
      - ragflow_token
      - aiui_key
    networks:
      - astron-net
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
```

#### 2. å®‰å…¨é…ç½®

```bash
# å¯†é’¥ç®¡ç†
mkdir -p /etc/astron-secrets
chmod 600 /etc/astron-secrets/*

# ç½‘ç»œå®‰å…¨
docker network create astron-net

# èµ„æºé™åˆ¶
docker run --memory=2g --cpus=2 \
  --ulimit nofile=65536:65536 \
  astron-knowledge:latest
```

#### 3. ç›‘æ§é…ç½®

```yaml
# Prometheusç›‘æ§é…ç½®
scrape_configs:
  - job_name: 'astron-knowledge'
    static_configs:
      - targets: ['knowledge:20010']
    metrics_path: '/api/metrics'
    scrape_interval: 15s
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. å¹¶å‘å¤„ç†ä¼˜åŒ–

```python
# åˆç†é…ç½®å·¥ä½œè¿›ç¨‹æ•°
workers = min(4, multiprocessing.cpu_count())

# è¿æ¥æ± é…ç½®
connector = aiohttp.TCPConnector(
    limit=100,           # æ€»è¿æ¥æ± å¤§å°
    limit_per_host=30,   # æ¯ä¸ªä¸»æœºçš„æœ€å¤§è¿æ¥æ•°
    keepalive_timeout=600,
    enable_cleanup_closed=True,
)
```

#### 2. ç¼“å­˜ç­–ç•¥

- **ä¼šè¯ç¼“å­˜**ï¼šå¤ç”¨HTTPè¿æ¥ä¼šè¯
- **é…ç½®ç¼“å­˜**ï¼šç¼“å­˜å¤–éƒ¨æœåŠ¡é…ç½®
- **ç»“æœç¼“å­˜**ï¼šç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„ç»“æœ

#### 3. é”™è¯¯å¤„ç†ä¼˜åŒ–

```python
# æŒ‡æ•°é€€é¿é‡è¯•
async def exponential_backoff_retry(func, max_retries=3):
    for attempt in range(max_retries):
        try:
            return await func()
        except TemporaryError as e:
            if attempt == max_retries - 1:
                raise
            await asyncio.sleep(2 ** attempt)  # 1s, 2s, 4s
```

### é›†æˆæµ‹è¯•

#### 1. å•å…ƒæµ‹è¯•

```python
# æµ‹è¯•RAGFlowç­–ç•¥
@pytest.mark.asyncio
async def test_ragflow_strategy_query():
    strategy = RagflowRAGStrategy()
    result = await strategy.query("æµ‹è¯•æŸ¥è¯¢", top_k=5)
    assert "results" in result
    assert len(result["results"]) <= 5
```

#### 2. é›†æˆæµ‹è¯•

```bash
# APIç«¯ç‚¹æµ‹è¯•
curl -X POST "http://localhost:20010/knowledge/v1/document/split" \
  -H "Content-Type: application/json" \
  -d '{"ragType":"RAGFlow","file":"test.pdf"}'

# å¥åº·æ£€æŸ¥æµ‹è¯•
curl -f "http://localhost:20010/api/metrics" || exit 1
```

### è¿ç»´è‡ªåŠ¨åŒ–

#### 1. CI/CDæµæ°´çº¿

```yaml
# GitHub Actionsç¤ºä¾‹
name: Deploy Knowledge Service
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build and push
        run: |
          docker build -t astron-knowledge:${GITHUB_SHA} .
          docker push astron-knowledge:${GITHUB_SHA}
      - name: Deploy
        run: |
          ssh user@server "docker pull astron-knowledge:${GITHUB_SHA}"
          ssh user@server "docker restart astron-knowledge"
```

#### 2. å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# health-check.sh

SERVICE_URL="http://localhost:20010"
TIMEOUT=30

# æ£€æŸ¥æœåŠ¡æ˜¯å¦å“åº”
response=$(curl -s -w "%{http_code}" -o /dev/null "$SERVICE_URL/api/metrics" -m $TIMEOUT)
if [ $response -eq 200 ]; then
    echo "Service is healthy"
    exit 0
else
    echo "Service is unhealthy (HTTP $response)"
    exit 1
fi
```

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥ç¡®ä¿çŸ¥è¯†åº“æœåŠ¡çš„ç¨³å®šè¿è¡Œã€é«˜æ€§èƒ½è¡¨ç°å’Œè‰¯å¥½çš„å¯ç»´æŠ¤æ€§ã€‚å®šæœŸç›‘æ§å’Œä¼˜åŒ–å°†å¸®åŠ©æ‚¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è·å¾—æœ€ä½³çš„æœåŠ¡è´¨é‡ã€‚