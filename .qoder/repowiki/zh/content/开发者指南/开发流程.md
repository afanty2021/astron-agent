# 开发流程

<cite>
**本文档引用的文件**
- [Makefile](file://Makefile)
- [console/frontend/package.json](file://console/frontend/package.json)
- [console/frontend/vite.config.js](file://console/frontend/vite.config.js)
- [console/backend/pom.xml](file://console/backend/pom.xml)
- [core/agent/main.py](file://core/agent/main.py)
- [core/workflow/main.py](file://core/workflow/main.py)
- [console/frontend/src/utils/http.ts](file://console/frontend/src/utils/http.ts)
- [core/agent/infra/config/fast_uvi.py](file://core/agent/infra/config/fast_uvi.py)
- [core/agent/infra/config/middleware.py](file://core/agent/infra/config/middleware.py)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [标准化任务执行](#标准化任务执行)
3. [前端开发服务器启动](#前端开发服务器启动)
4. [后端服务启动](#后端服务启动)
5. [前后端联调配置](#前后端联调配置)
6. [微服务通信机制](#微服务通信机制)
7. [API调用方式](#api调用方式)
8. [代码热重载与实时监控](#代码热重载与实时监控)
9. [常见开发任务操作范例](#常见开发任务操作范例)

## 项目结构

本项目采用多语言微服务架构，主要包含前端、后端和核心服务三个部分。前端使用React + Vite技术栈，后端包含Java Spring Boot服务和Python FastAPI服务。项目通过Makefile提供统一的开发工作流管理。

**Section sources**
- [Makefile](file://Makefile)
- [console/frontend/package.json](file://console/frontend/package.json)
- [console/backend/pom.xml](file://console/backend/pom.xml)

## 标准化任务执行

项目通过Makefile提供了一套智能化的标准化任务执行体系，支持代码格式化、质量检查、测试、构建等核心开发任务。

### 核心命令
Makefile提供了15个核心命令，分为三个层级：

**Tier 1: 日常核心命令**
- `make setup`: 一次性环境设置（工具+钩子+分支策略）
- `make format`: 智能代码格式化
- `make check`: 代码质量检查
- `make test`: 运行测试
- `make build`: 构建项目
- `make push`: 安全推送至远程仓库
- `make clean`: 清理构建产物

**Tier 2: 专业命令**
- `make status`: 显示详细项目状态
- `make info`: 显示工具和依赖信息
- `make lint`: 代码linting（check的别名）
- `make fix`: 自动修复代码问题
- `make ci`: 完整CI流水线（format+check+test+build）

**Tier 3: 高级命令**
- `make hooks`: Git钩子管理菜单
- `make enable-legacy`: 启用完整的传统命令集

这些命令通过智能检测机制自动识别活跃项目，无需手动指定项目类型。

**Section sources**
- [Makefile](file://Makefile#L1-L145)

## 前端开发服务器启动

前端项目使用Vite作为开发服务器，提供了快速的热重载和开发体验。

### 启动方式
通过npm scripts启动前端开发服务器：
- `npm run dev`: 启动开发环境服务器
- `npm run test`: 启动测试环境服务器
- `npm run build`: 构建生产环境代码

### 配置说明
Vite配置文件(vite.config.js)中定义了关键配置：
- 开发服务器端口为3000
- 环境变量前缀为`CONSOLE_`和`VITE_`
- 配置了多个代理规则，将API请求转发到后端服务

**Section sources**
- [console/frontend/package.json](file://console/frontend/package.json#L5-L25)
- [console/frontend/vite.config.js](file://console/frontend/vite.config.js#L1-L97)

## 后端服务启动

后端服务包含多个基于FastAPI的Python服务，通过main.py作为入口点启动。

### Agent服务启动
Agent服务是核心后端服务之一，启动流程如下：
1. 设置Python路径
2. 加载环境配置文件(config.env)
3. 启动FastAPI应用(api/app.py)

服务配置参数包括：
- `SERVICE_PORT`: 服务端口，默认17870
- `SERVICE_WORKERS`: 工作进程数
- `SERVICE_RELOAD`: 是否启用热重载

### Workflow服务启动
Workflow服务使用Uvicorn作为ASGI服务器，配置如下：
- 主机: 0.0.0.0
- 端口: 从环境变量SERVICE_PORT获取，默认7880
- 工作进程数: 从环境变量WORKERS获取，或为CPU核心数+1
- 热重载: 从环境变量RELOAD获取

**Section sources**
- [core/agent/main.py](file://core/agent/main.py#L0-L109)
- [core/workflow/main.py](file://core/workflow/main.py#L0-L167)
- [core/agent/infra/config/fast_uvi.py](file://core/agent/infra/config/fast_uvi.py#L0-L12)

## 前后端联调配置

项目通过Vite的代理功能实现前后端联调，避免跨域问题。

### 代理配置
在vite.config.js中配置了多个代理规则：
- `/xingchen-api`: 代理到联调服务器地址 http://172.29.202.54:8080
- `/chat-`: 代理到测试服务器地址 http://172.29.201.92:8081
- `/workflow`: 代理到测试服务器地址 http://172.29.201.92:8080

### 环境适配
前端通过以下逻辑确定baseURL：
1. 生产环境：使用`/console-api`
2. 本地开发：使用`/xingchen-api`
3. 其他环境：根据环境变量或默认服务器地址

这种配置使得开发者可以在不同环境中无缝切换，无需修改代码。

**Section sources**
- [console/frontend/vite.config.js](file://console/frontend/vite.config.js#L40-L97)
- [console/frontend/src/utils/http.ts](file://console/frontend/src/utils/http.ts#L430-L485)

## 微服务通信机制

系统采用微服务架构，各服务之间通过HTTP API进行通信。

### 服务配置
在middleware.py中定义了各微服务的URL配置：
- **Link服务**: 获取链接、版本和运行链接的URL
- **Workflow服务**: 获取工作流和SSE基础URL
- **Knowledge服务**: 查询知识块的URL
- **MCP服务**: 列出和运行MCP插件的URL
- **AppAuth服务**: 应用认证相关的主机、路由和端口

### 通信模式
服务间通信采用RESTful API模式，通过预定义的URL进行HTTP请求。这种集中式配置方式便于服务地址的统一管理和变更。

**Section sources**
- [core/agent/infra/config/middleware.py](file://core/agent/infra/config/middleware.py#L0-L63)

## API调用方式

前后端及微服务间的API调用采用标准化的HTTP请求模式。

### 前端API调用
前端通过封装的http工具进行API调用，主要特点包括：
- 使用axios作为HTTP客户端
- 统一处理请求拦截和响应拦截
- 自动添加认证头(Authorization)
- 支持空间ID(space-id)和企业ID(enterprise-id)传递
- 实现请求去重和取消机制
- 支持JWT令牌自动刷新

### 典型API调用
```typescript
// 获取通用配置
export async function getCommonConfig(params: {
  category: string;
  code: string;
}): Promise<unknown> {
  return await http.get('/config-info/get-by-category-and-code', {
    params,
  });
}
```

### 错误处理
系统实现了完善的错误处理机制：
- 401错误：自动跳转到登录页
- 业务错误：根据错误码进行特定处理
- 网络错误：显示友好的错误提示
- 重复请求：自动取消之前的请求

**Section sources**
- [console/frontend/src/utils/http.ts](file://console/frontend/src/utils/http.ts#L0-L485)
- [console/frontend/src/services/common.ts](file://console/frontend/src/services/common.ts#L0-L107)

## 代码热重载与实时监控

项目提供了完善的开发体验，包括代码热重载和实时监控功能。

### 热重载配置
- **前端**: Vite默认支持热重载，修改代码后浏览器自动刷新
- **后端**: 通过`SERVICE_RELOAD=true`启用Uvicorn的自动重载功能

### 日志查看
- **前端**: 控制台输出详细的请求和响应信息
- **后端**: 使用loguru进行日志记录，包含路由注册、服务启动等信息

### 实时监控
- **开发服务器**: Vite提供实时构建状态和错误提示
- **API调用**: 前端http工具记录所有请求，便于调试
- **服务状态**: 后端服务启动时打印关键环境变量

### 调试工具
- **Code Inspector**: 集成code-inspector-plugin，支持在编辑器中直接调试
- **环境检测**: Makefile提供_debug命令测试项目检测状态

**Section sources**
- [core/workflow/main.py](file://core/workflow/main.py#L150-L167)
- [console/frontend/vite.config.js](file://console/frontend/vite.config.js#L10-L25)
- [Makefile](file://Makefile#L140-L145)

## 常见开发任务操作范例

### 添加新功能模块
1. 在相应服务目录创建新模块
2. 在API路由中注册新端点
3. 使用`make format`格式化代码
4. 使用`make check`进行质量检查
5. 使用`make test`运行测试

### 修改现有服务接口
1. 更新API schema定义
2. 修改服务实现逻辑
3. 更新相关配置文件
4. 运行`make ci`执行完整CI流程
5. 提交代码前使用`make push`进行安全推送

### 最佳实践
- 使用`make setup`进行一次性环境设置
- 开发过程中频繁使用`make format`和`make check`
- 提交代码前务必运行`make ci`
- 使用`make status`了解项目状态
- 遇到问题时使用`make info`查看工具信息

这些操作范例和最佳实践确保了开发流程的一致性和代码质量。

**Section sources**
- [Makefile](file://Makefile#L1-L145)
- [core/agent/main.py](file://core/agent/main.py#L0-L109)
- [console/frontend/vite.config.js](file://console/frontend/vite.config.js#L1-L97)