# 核心实体

<cite>
**本文档中引用的文件**  
- [flow.py](file://core/workflow/domain/models/flow.py)
- [history.py](file://core/workflow/domain/models/history.py)
- [license.py](file://core/workflow/domain/models/license.py)
- [flow.py](file://core/workflow/domain/entities/flow.py)
- [history.py](file://core/workflow/engine/entities/history.py)
- [license.py](file://core/workflow/cache/license.py)
- [flow_dao.py](file://core/workflow/repository/flow_dao.py)
- [license_dao.py](file://core/workflow/repository/license_dao.py)
</cite>

## 目录
1. [工作流模型](#工作流模型)  
2. [历史记录模型](#历史记录模型)  
3. [许可证模型](#许可证模型)

## 工作流模型

工作流模型（flow.py）是系统中用于定义和管理工作流的核心数据实体。该模型存储了工作流的结构、元数据、版本信息和发布状态，支持工作流的创建、更新、版本控制和发布管理。

### 字段解析

| 字段名 | 数据类型 | 约束条件 | 业务含义 |
|--------|--------|--------|--------|
| id | int | 主键，唯一，自动生成 | 工作流的唯一标识符，使用雪花算法生成 |
| group_id | int | 索引，唯一 | 工作流所属的组标识符，用于组织和分类工作流 |
| name | str | 索引，默认值为空字符串 | 工作流的名称，用于用户识别 |
| data | Dict | JSON字段，默认为空字典 | 存储工作流的结构数据，包括节点和边的定义 |
| release_data | Dict | JSON字段，默认为空字典 | 存储已发布的工作流数据，用于生产环境执行 |
| description | str | 索引，默认值为空字符串 | 工作流的描述信息，用于说明工作流的功能和用途 |
| version | str | 索引，默认值为空字符串 | 工作流的版本号，遵循语义化版本控制（如v3.1.0） |
| release_status | int | 默认值为0 | 发布状态：0表示未发布，1表示已发布 |
| app_id | str | 默认值为空字符串 | 关联的应用程序标识符 |
| source | int | 默认值为0 | 工作流的来源标识 |
| create_at | datetime | 默认为当前时间 | 工作流的创建时间戳 |
| tag | int | 默认值为0 | 工作流的标签，用于分类和过滤 |
| update_at | datetime | 默认为当前时间 | 工作流的最后更新时间戳 |

### 主键与索引策略

- **主键**：`id` 字段作为主键，确保每条记录的唯一性。
- **唯一索引**：`group_id` 字段具有唯一约束，防止同一组内出现重复的工作流。
- **普通索引**：`name`、`description`、`version` 和 `release_status` 字段均建立索引，以提高查询性能。
- **JSON字段**：`data` 和 `release_data` 使用数据库的JSON类型存储，支持复杂的嵌套结构查询。

**Section sources**
- [flow.py](file://core/workflow/domain/models/flow.py#L1-L53)
- [flow.py](file://core/workflow/domain/entities/flow.py#L1-L129)

## 历史记录模型

历史记录模型（history.py）用于跟踪工作流节点的执行历史，记录用户交互和节点响应，支持会话持久化和审计追踪功能。

### 字段解析

| 字段名 | 数据类型 | 约束条件 | 业务含义 |
|--------|--------|--------|--------|
| id | int | 主键，自增 | 历史记录的唯一标识符 |
| node_id | str | 最大长度255，非空 | 执行节点的标识符 |
| uid | str | 最大长度255，非空 | 触发执行的用户标识符 |
| chat_id | str | 最大长度255，可为空 | 可选的聊天会话标识符，用于关联会话上下文 |
| raw_question | str | 可为空 | 用户的原始问题或输入内容 |
| raw_answer | str | 可为空 | 节点返回的原始响应内容 |
| create_time | datetime | 默认为当前时间 | 历史记录的创建时间 |
| flow_id | str | 最大长度255，可为空 | 可选的工作流标识符，用于关联特定工作流 |

### 业务作用

- **会话持久化**：通过 `chat_id` 字段将多个交互关联到同一个会话中，支持多轮对话的上下文保持。
- **审计追踪**：记录每次节点执行的详细信息，包括用户输入、AI响应和执行时间，便于问题排查和行为分析。
- **性能优化**：支持按用户、节点或时间范围查询历史记录，辅助性能分析和使用模式研究。

**Section sources**
- [history.py](file://core/workflow/domain/models/history.py#L1-L45)
- [history.py](file://core/workflow/engine/entities/history.py#L1-L200)

## 许可证模型

许可证模型（license.py）用于管理系统中应用程序的授权信息，实现基于许可证的访问控制和资源管理。

### 字段解析

| 字段名 | 数据类型 | 约束条件 | 业务含义 |
|--------|--------|--------|--------|
| id | int | 主键，唯一，自动生成 | 许可证的唯一标识符 |
| app_id | int | 非空 | 关联的应用程序标识符 |
| group_id | int | 非空 | 关联的组标识符 |
| status | int | 默认值为1，索引 | 许可证状态：1表示激活，0表示停用 |
| create_at | datetime | 默认为当前时间 | 许可证的创建时间 |
| update_at | datetime | 默认为当前时间 | 许可证的最后更新时间 |

### 授权管理角色

- **租户关联**：通过 `app_id` 和 `group_id` 实现许可证与应用程序和组织单元的绑定，支持多租户架构。
- **状态管理**：`status` 字段控制许可证的激活状态，支持动态启用或禁用访问权限。
- **审计支持**：创建和更新时间戳提供完整的生命周期追踪，满足合规性要求。

### 缓存策略

系统通过 Redis 缓存许可证信息，使用 `license:license_info:new:{app_id}:{group_id}` 作为键名，显著提升授权验证的性能。

**Section sources**
- [license.py](file://core/workflow/domain/models/license.py#L1-L37)
- [license.py](file://core/workflow/cache/license.py#L1-L41)
- [license_dao.py](file://core/workflow/repository/license_dao.py#L1-L46)