# 环境搭建

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [console/frontend/package.json](file://console/frontend/package.json)
- [core/agent/pyproject.toml](file://core/agent/pyproject.toml)
- [core/common/pyproject.toml](file://core/common/pyproject.toml)
- [core/knowledge/pyproject.toml](file://core/knowledge/pyproject.toml)
- [core/memory/database/pyproject.toml](file://core/memory/database/pyproject.toml)
- [core/plugin/aitools/pyproject.toml](file://core/plugin/aitools/pyproject.toml)
- [core/plugin/link/pyproject.toml](file://core/plugin/link/pyproject.toml)
- [core/plugin/rpa/pyproject.toml](file://core/plugin/rpa/pyproject.toml)
- [core/tenant/go.mod](file://core/tenant/go.mod)
- [docker/astronAgent/docker-compose-with-auth.yaml](file://docker/astronAgent/docker-compose-with-auth.yaml)
- [console/frontend/.env.development](file://console/frontend/.env.development)
- [console/frontend/.env.production](file://console/frontend/.env.production)
- [console/backend/hub/pom.xml](file://console/backend/hub/pom.xml)
- [core/agent/main.py](file://core/agent/main.py)
- [core/tenant/main.go](file://core/tenant/main.go)
</cite>

## 目录
1. [简介](#简介)
2. [基础依赖安装](#基础依赖安装)
3. [前端环境配置](#前端环境配置)
4. [Python服务依赖配置](#python服务依赖配置)
5. [Go服务依赖配置](#go服务依赖配置)
6. [Docker环境启动](#docker环境启动)
7. [Casdoor认证服务配置](#casdoor认证服务配置)
8. [环境变量与数据库初始化](#环境变量与数据库初始化)
9. [常见问题解决方案](#常见问题解决方案)
10. [调试命令](#调试命令)

## 简介
本指南提供详细的本地开发环境搭建步骤，涵盖Node.js、Python、Go、Docker等基础依赖的安装配置。指导开发者通过package.json安装前端依赖，通过pyproject.toml安装各核心服务的Python依赖，并使用docker-compose.yaml启动完整的微服务环境。同时包含Casdoor认证服务的配置方法、环境变量设置、数据库初始化和对象存储连接等关键配置。

## 基础依赖安装
### Node.js安装
前端项目基于Vite构建，需要Node.js环境：
```bash
# 推荐使用nvm管理Node.js版本
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# 安装Node.js 18.x LTS版本
nvm install 18
nvm use 18
nvm alias default 18

# 验证安装
node --version
npm --version
```

### Python安装
Python服务需要Python 3.11+版本：
```bash
# 使用pyenv管理Python版本（推荐）
curl https://pyenv.run | bash
source ~/.bashrc

# 安装Python 3.11.7
pyenv install 3.11.7
pyenv global 3.11.7

# 验证安装
python --version
pip --version
```

### Go安装
Tenant服务基于Go语言开发：
```bash
# 下载并安装Go 1.23
wget https://golang.org/dl/go1.23.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.23.linux-amd64.tar.gz

# 配置环境变量
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
echo 'export GOPATH=$HOME/go' >> ~/.bashrc
source ~/.bashrc

# 验证安装
go version
```

### Docker安装
完整的微服务环境依赖Docker和Docker Compose：
```bash
# Ubuntu/Debian系统
sudo apt-get update
sudo apt-get install docker.io docker-compose

# 验证安装
docker --version
docker-compose --version

# 将当前用户添加到docker组（避免使用sudo）
sudo usermod -aG docker $USER
```

**Section sources**
- [README.md](file://README.md#L1-L128)

## 前端环境配置
### 依赖安装
前端项目位于`console/frontend`目录，使用npm或pnpm安装依赖：
```bash
# 进入前端目录
cd console/frontend

# 使用npm安装依赖
npm install

# 或使用pnpm安装依赖（推荐）
pnpm install
```

### 环境变量配置
项目包含多个环境配置文件，主要配置Casdoor认证和API地址：
```bash
# 查看现有的环境配置
ls .env.*

# 开发环境配置文件示例
cat .env.development
```

关键环境变量说明：
- `CONSOLE_CASDOOR_URL`: Casdoor认证服务地址
- `CONSOLE_CASDOOR_ID`: Casdoor客户端ID
- `CONSOLE_CASDOOR_APP`: Casdoor应用名称
- `VITE_BASE_URL`: 后端API基础URL

### 开发服务器启动
```bash
# 启动开发服务器
npm run dev

# 或使用pnpm
pnpm dev

# 构建生产版本
npm run build
```

**Section sources**
- [console/frontend/package.json](file://console/frontend/package.json#L1-L137)
- [console/frontend/.env.development](file://console/frontend/.env.development#L1-L7)
- [console/frontend/.env.production](file://console/frontend/.env.production#L1-L20)

## Python服务依赖配置
项目包含多个Python微服务，每个服务都有独立的`pyproject.toml`文件管理依赖。

### Agent服务依赖
位于`core/agent/`目录：
```bash
cd core/agent

# 创建虚拟环境
python -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
# 或使用uv（推荐）
uv pip install -r requirements.txt
```

主要依赖包括：
- FastAPI: Web框架
- SQLAlchemy: 数据库ORM
- Redis: 缓存服务
- OpenTelemetry: 监控追踪
- Pydantic: 数据验证

### Common服务依赖
位于`core/common/`目录：
```bash
cd core/common
pip install -r requirements.txt
```

### 其他Python服务
其他Python服务包括：
- `core/knowledge/`: 知识库服务
- `core/memory/database/`: 数据库服务
- `core/plugin/aitools/`: AI工具服务
- `core/plugin/link/`: 工具链接服务
- `core/plugin/rpa/`: RPA自动化服务
- `core/workflow/`: 工作流服务

每个服务的依赖安装方式相同：
```bash
cd core/<service_name>
pip install -r requirements.txt
```

**Section sources**
- [core/agent/pyproject.toml](file://core/agent/pyproject.toml#L1-L228)
- [core/common/pyproject.toml](file://core/common/pyproject.toml#L1-L54)
- [core/knowledge/pyproject.toml](file://core/knowledge/pyproject.toml#L1-L48)
- [core/memory/database/pyproject.toml](file://core/memory/database/pyproject.toml#L1-L46)
- [core/plugin/aitools/pyproject.toml](file://core/plugin/aitools/pyproject.toml#L1-L58)
- [core/plugin/link/pyproject.toml](file://core/plugin/link/pyproject.toml#L1-L44)
- [core/plugin/rpa/pyproject.toml](file://core/plugin/rpa/pyproject.toml#L1-L45)

## Go服务依赖配置
Tenant服务基于Go语言开发，位于`core/tenant/`目录。

### 依赖管理
Go模块使用go.mod文件管理依赖：
```bash
cd core/tenant

# 下载所有依赖
go mod download

# 验证依赖
go mod verify

# 列出依赖
go list -m all
```

主要依赖包括：
- github.com/gin-gonic/gin: Web框架
- github.com/go-sql-driver/mysql: MySQL驱动
- github.com/google/uuid: UUID生成
- github.com/BurntSushi/toml: TOML配置文件解析

### 服务启动
```bash
# 编译并运行
go run main.go

# 或编译为可执行文件
go build -o tenant main.go
./tenant
```

**Section sources**
- [core/tenant/go.mod](file://core/tenant/go.mod#L1-L42)
- [core/tenant/main.go](file://core/tenant/main.go#L1-L15)

## Docker环境启动
### 环境准备
```bash
# 克隆仓库
git clone https://github.com/iflytek/astron-agent.git
cd astron-agent

# 进入Docker配置目录
cd docker/astronAgent
```

### 环境变量配置
```bash
# 复制示例环境变量文件
cp .env.example .env

# 编辑环境变量
vim .env
```

### 启动完整服务
使用包含Casdoor认证的Compose文件：
```bash
# 启动所有服务
docker compose -f docker-compose-with-auth.yaml up -d

# 查看服务状态
docker compose -f docker-compose-with-auth.yaml ps

# 查看日志
docker compose -f docker-compose-with-auth.yaml logs -f
```

### 服务访问
启动后可通过以下地址访问服务：
- **Casdoor管理界面**: http://localhost:8000
- **AstronAgent前端**: http://localhost/
- **默认登录凭证**: 用户名: `admin`, 密码: `123`

**Section sources**
- [README.md](file://README.md#L1-L128)
- [docker/astronAgent/docker-compose-with-auth.yaml](file://docker/astronAgent/docker-compose-with-auth.yaml#L1-L15)

## Casdoor认证服务配置
### 配置文件
Casdoor服务的配置主要通过环境变量和配置文件完成。

### 前端配置
前端通过`.env`文件配置Casdoor参数：
```bash
# 在console/frontend/.env文件中
CONSOLE_CASDOOR_URL=http://localhost:8000
CONSOLE_CASDOOR_ID=your-client-id
CONSOLE_CASDOOR_APP=astronAgent
CONSOLE_CASDOOR_ORG=built-in
```

### 后端配置
后端服务通过`config.env`文件配置Casdoor：
```bash
# 在各服务的config.env文件中
CASDOOR_ENDPOINT=http://casdoor:8000
CASDOOR_CLIENT_ID=your-client-id
CASDOOR_CLIENT_SECRET=your-client-secret
CASDOOR_CERTIFICATE=your-certificate
CASDOOR_ORGANIZATION=built-in
CASDOOR_APPLICATION=astronAgent
```

### 应用配置
在Casdoor管理界面中配置AstronAgent应用：
1. 登录Casdoor管理界面（http://localhost:8000）
2. 进入"Applications"页面
3. 创建新应用或编辑现有应用
4. 配置回调URL为前端地址
5. 获取Client ID和Client Secret

**Section sources**
- [console/frontend/.env.development](file://console/frontend/.env.development#L1-L7)
- [console/frontend/.env.production](file://console/frontend/.env.production#L1-L20)

## 环境变量与数据库初始化
### 环境变量配置
项目使用多个`config.env`文件进行环境变量配置：
```bash
# 查找所有config.env文件
find . -name "config.env"

# 示例配置文件位置
core/agent/config.env.example
docker/astronAgent/config/agent/config.env
docker/astronAgent/config/workflow/config.env
```

### 数据库初始化
MySQL数据库初始化脚本位于`docker/astronAgent/mysql/`目录：
```bash
# 查看初始化脚本
ls docker/astronAgent/mysql/*.sql

# agent.sql: Agent服务数据库
# link.sql: Link服务数据库  
# tenant.sql: Tenant服务数据库
# workflow.sql: Workflow服务数据库
```

Docker Compose会自动执行这些SQL脚本进行数据库初始化。

### 对象存储连接
对象存储配置主要在各服务的`config.env`文件中：
```bash
# S3兼容的对象存储配置
S3_ENDPOINT=your-s3-endpoint
S3_ACCESS_KEY=your-access-key
S3_SECRET_KEY=your-secret-key
S3_BUCKET_NAME=your-bucket-name
S3_REGION=your-region
```

**Section sources**
- [core/agent/main.py](file://core/agent/main.py#L1-L110)

## 常见问题解决方案
### 端口冲突
当端口被占用时，可修改`.env`文件中的端口配置：
```bash
# 在.docker/.env文件中
HTTP_PORT=8080
HTTPS_PORT=8443
CASDOOR_PORT=8000
MYSQL_PORT=3306
```

### 依赖版本不匹配
解决Python依赖版本冲突：
```bash
# 清理并重新安装
rm -rf venv
python -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

解决Node.js依赖问题：
```bash
# 清理node_modules
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
```

### Docker启动失败
检查Docker服务状态：
```bash
# 检查Docker是否运行
sudo systemctl status docker

# 查看磁盘空间
df -h

# 清理Docker资源
docker system prune -a
```

### 数据库连接问题
检查数据库服务是否正常运行：
```bash
# 查看MySQL容器
docker ps | grep mysql

# 进入MySQL容器
docker exec -it mysql-container mysql -u root -p

# 检查数据库是否初始化
SHOW DATABASES;
USE agent;
SHOW TABLES;
```

## 调试命令
### 服务状态检查
```bash
# 查看所有容器状态
docker-compose ps

# 查看特定服务日志
docker-compose logs agent
docker-compose logs workflow
docker-compose logs casdoor

# 实时查看日志
docker-compose logs -f
```

### 网络连接测试
```bash
# 测试服务间连接
docker-compose exec agent curl -v http://workflow:8000/health
docker-compose exec agent curl -v http://casdoor:8000/health

# 进入容器内部调试
docker-compose exec agent /bin/bash
docker-compose exec mysql /bin/bash
```

### 数据库调试
```bash
# 连接MySQL数据库
mysql -h localhost -P 3306 -u root -p

# 执行SQL查询
USE agent;
SELECT * FROM users LIMIT 10;
```

### API测试
```bash
# 测试Agent服务健康检查
curl http://localhost:8080/agent/health

# 测试Workflow服务
curl http://localhost:8080/workflow/health

# 测试Casdoor服务
curl http://localhost:8000/api/get-account
```