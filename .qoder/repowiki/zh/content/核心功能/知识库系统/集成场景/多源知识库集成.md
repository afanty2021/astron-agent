# å¤šæºçŸ¥è¯†åº“é›†æˆ

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [main.py](file://core/knowledge/main.py)
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py)
- [rag_strategy_factory.py](file://core/knowledge/service/rag_strategy_factory.py)
- [api.py](file://core/knowledge/api/v1/api.py)
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py)
- [sparkdesk_strategy.py](file://core/knowledge/service/impl/sparkdesk_strategy.py)
- [aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py)
- [cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py)
- [chunk_dto.py](file://core/knowledge/domain/entity/chunk_dto.py)
- [rag_do.py](file://core/knowledge/domain/entity/rag_do.py)
- [aiui.py](file://core/knowledge/infra/aiui/aiui.py)
- [sparkdesk.py](file://core/knowledge/infra/desk/sparkdesk.py)
- [ragflow_client.py](file://core/knowledge/infra/ragflow/ragflow_client.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ”¯æŒçš„çŸ¥è¯†åº“åç«¯](#æ”¯æŒçš„çŸ¥è¯†åº“åç«¯)
5. [ç»Ÿä¸€è®¿é—®æ¥å£è®¾è®¡](#ç»Ÿä¸€è®¿é—®æ¥å£è®¾è®¡)
6. [æŸ¥è¯¢è·¯ç”±æœºåˆ¶](#æŸ¥è¯¢è·¯ç”±æœºåˆ¶)
7. [æ•°æ®æ ¼å¼ä¸æ£€ç´¢èƒ½åŠ›å·®å¼‚](#æ•°æ®æ ¼å¼ä¸æ£€ç´¢èƒ½åŠ›å·®å¼‚)
8. [è·¨çŸ¥è¯†åº“è”åˆæŸ¥è¯¢](#è·¨çŸ¥è¯†åº“è”åˆæŸ¥è¯¢)
9. [è¿ç»´åŠŸèƒ½](#è¿ç»´åŠŸèƒ½)
10. [è¿ç§»æŒ‡å—](#è¿ç§»æŒ‡å—)

## ç®€ä»‹

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¤šæºçŸ¥è¯†åº“é›†æˆå¹³å°ï¼Œæ—¨åœ¨ç»Ÿä¸€ç®¡ç†å’Œè®¿é—®å¤šç§ä¸åŒç±»å‹çš„çŸ¥è¯†åº“åç«¯ï¼ŒåŒ…æ‹¬Ragflowã€AIUIã€SparkDeskå’ŒCBGç­‰ã€‚ç³»ç»Ÿé€šè¿‡æŠ½è±¡åŒ–çš„è®¾è®¡æ¨¡å¼ï¼Œä¸ºä¸Šå±‚åº”ç”¨æä¾›ç»Ÿä¸€çš„APIæ¥å£ï¼Œå±è”½äº†åº•å±‚ä¸åŒçŸ¥è¯†åº“çš„æŠ€æœ¯å·®å¼‚ã€‚å¹³å°æ”¯æŒæ–‡æ¡£åˆ‡ç‰‡ã€çŸ¥è¯†å—ç®¡ç†ã€ç›¸ä¼¼æ€§æ£€ç´¢ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå¹¶é€šè¿‡å·¥å‚æ¨¡å¼å®ç°ä¸åŒçŸ¥è¯†åº“ç­–ç•¥çš„åŠ¨æ€è·¯ç”±ã€‚ç³»ç»Ÿé‡‡ç”¨å¼‚æ­¥éé˜»å¡æ¶æ„ï¼Œç¡®ä¿é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼ŒåŒæ—¶é›†æˆäº†å®Œæ•´çš„ç›‘æ§å’Œè¿½è¸ªç³»ç»Ÿï¼Œä¾¿äºè¿ç»´å’Œé—®é¢˜æ’æŸ¥ã€‚

## ç³»ç»Ÿæ¶æ„

ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†ä¸ºAPIæ¥å£å±‚ã€æœåŠ¡å±‚ã€ç­–ç•¥å±‚å’ŒåŸºç¡€è®¾æ–½å±‚ã€‚APIæ¥å£å±‚æä¾›RESTfulæ¥å£ï¼ŒæœåŠ¡å±‚è´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†å’Œå¼‚å¸¸ç®¡ç†ï¼Œç­–ç•¥å±‚é€šè¿‡å·¥å‚æ¨¡å¼å®ç°ä¸åŒçŸ¥è¯†åº“çš„è·¯ç”±ï¼ŒåŸºç¡€è®¾æ–½å±‚å°è£…äº†ä¸å„ä¸ªçŸ¥è¯†åº“åç«¯çš„å…·ä½“äº¤äº’ç»†èŠ‚ã€‚

```mermaid
graph TD
subgraph "APIæ¥å£å±‚"
API[APIè·¯ç”±]
end
subgraph "æœåŠ¡å±‚"
Service[æœåŠ¡åè°ƒ]
end
subgraph "ç­–ç•¥å±‚"
Factory[RAGç­–ç•¥å·¥å‚]
StrategyA[AIUIç­–ç•¥]
StrategyB[SparkDeskç­–ç•¥]
StrategyC[Ragflowç­–ç•¥]
StrategyD[CBGç­–ç•¥]
end
subgraph "åŸºç¡€è®¾æ–½å±‚"
InfraA[AIUIå®¢æˆ·ç«¯]
InfraB[SparkDeskå®¢æˆ·ç«¯]
InfraC[Ragflowå®¢æˆ·ç«¯]
InfraD[CBGå®¢æˆ·ç«¯]
end
API --> Service
Service --> Factory
Factory --> StrategyA
Factory --> StrategyB
Factory --> StrategyC
Factory --> StrategyD
StrategyA --> InfraA
StrategyB --> InfraB
StrategyC --> InfraC
StrategyD --> InfraD
```

**å›¾è¡¨æ¥æº**
- [main.py](file://core/knowledge/main.py)
- [api.py](file://core/knowledge/api/v1/api.py)
- [rag_strategy_factory.py](file://core/knowledge/service/rag_strategy_factory.py)

## æ ¸å¿ƒç»„ä»¶

ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬RAGç­–ç•¥æŠ½è±¡åŸºç±»ã€ç­–ç•¥å·¥å‚ã€ç»Ÿä¸€APIæ¥å£å’ŒåŸºç¡€è®¾æ–½å®¢æˆ·ç«¯ã€‚RAGç­–ç•¥åŸºç±»å®šä¹‰äº†æ‰€æœ‰çŸ¥è¯†åº“å¿…é¡»å®ç°çš„æ¥å£ï¼ŒåŒ…æ‹¬æŸ¥è¯¢ã€åˆ‡ç‰‡ã€ä¿å­˜ã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œã€‚ç­–ç•¥å·¥å‚æ ¹æ®è¯·æ±‚ä¸­çš„ragTypeå‚æ•°åŠ¨æ€åˆ›å»ºç›¸åº”çš„ç­–ç•¥å®ä¾‹ã€‚ç»Ÿä¸€APIæ¥å£å¯¹æ‰€æœ‰æ“ä½œè¿›è¡Œæ ‡å‡†åŒ–å¤„ç†ï¼ŒåŒ…æ‹¬å‚æ•°éªŒè¯ã€é”™è¯¯å¤„ç†å’Œæ€§èƒ½ç›‘æ§ã€‚åŸºç¡€è®¾æ–½å®¢æˆ·ç«¯å°è£…äº†ä¸å„ä¸ªçŸ¥è¯†åº“åç«¯çš„å…·ä½“é€šä¿¡ç»†èŠ‚ï¼ŒåŒ…æ‹¬è®¤è¯ã€è¯·æ±‚æ„å»ºå’Œå“åº”è§£æã€‚

**ç« èŠ‚æ¥æº**
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py)
- [rag_strategy_factory.py](file://core/knowledge/service/rag_strategy_factory.py)
- [api.py](file://core/knowledge/api/v1/api.py)

## æ”¯æŒçš„çŸ¥è¯†åº“åç«¯

### Ragflow

Ragflowæ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„çŸ¥è¯†åº“åç«¯ï¼Œæ”¯æŒæ–‡æ¡£ä¸Šä¼ ã€è§£æã€åˆ‡ç‰‡ã€å­˜å‚¨å’Œæ£€ç´¢ç­‰å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ç³»ç»Ÿé€šè¿‡`RagflowRAGStrategy`ç±»å®ç°ä¸Ragflowçš„é›†æˆï¼Œè¯¥ç±»å°è£…äº†æ•°æ®é›†ç®¡ç†ã€æ–‡æ¡£ä¸Šä¼ ã€è§£æè§¦å‘ã€åˆ‡ç‰‡è·å–ç­‰å¤æ‚æµç¨‹ã€‚Ragflowç­–ç•¥æ”¯æŒæ‰€æœ‰æ ¸å¿ƒæ“ä½œï¼ŒåŒ…æ‹¬æŸ¥è¯¢ã€åˆ‡ç‰‡ã€ä¿å­˜ã€æ›´æ–°å’Œåˆ é™¤ã€‚

```mermaid
classDiagram
class RagflowRAGStrategy {
+query(query, doc_ids, repo_ids, top_k, threshold)
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff)
+chunks_save(docId, group, uid, chunks)
+chunks_update(docId, group, uid, chunks)
+chunks_delete(docId, chunkIds)
+query_doc(docId)
+query_doc_name(docId)
}
RagflowRAGStrategy --|> RAGStrategy : å®ç°
```

**å›¾è¡¨æ¥æº**
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py)
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py)

### AIUI

AIUIæ˜¯ç§‘å¤§è®¯é£æä¾›çš„çŸ¥è¯†åº“æœåŠ¡ï¼Œä¸»è¦æ”¯æŒåŸºäºæ–‡æ¡£çš„æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰åŠŸèƒ½ã€‚ç³»ç»Ÿé€šè¿‡`AIUIRAGStrategy`ç±»å®ç°ä¸AIUIçš„é›†æˆï¼Œè¯¥ç±»åˆ©ç”¨AIUIæä¾›çš„APIè¿›è¡Œæ–‡æ¡£è§£æã€åˆ‡ç‰‡ã€ä¿å­˜å’ŒæŸ¥è¯¢ã€‚AIUIç­–ç•¥æ”¯æŒå®Œæ•´çš„çŸ¥è¯†ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ–‡æ¡£åˆ‡ç‰‡ã€çŸ¥è¯†å—ä¿å­˜ã€æ›´æ–°ã€åˆ é™¤å’ŒæŸ¥è¯¢ã€‚

```mermaid
classDiagram
class AIUIRAGStrategy {
+query(query, doc_ids, repo_ids, top_k, threshold)
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff)
+chunks_save(docId, group, uid, chunks)
+chunks_update(docId, group, uid, chunks)
+chunks_delete(docId, chunkIds)
+query_doc(docId)
+query_doc_name(docId)
}
AIUIRAGStrategy --|> RAGStrategy : å®ç°
```

**å›¾è¡¨æ¥æº**
- [aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py)
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py)

### SparkDesk

SparkDeskæ˜¯ç§‘å¤§è®¯é£æä¾›çš„å¦ä¸€ä¸ªçŸ¥è¯†åº“æœåŠ¡ï¼Œä¸»è¦ä¾§é‡äºåŸºäºçŸ¥è¯†åº“çš„é—®ç­”åŠŸèƒ½ã€‚ç³»ç»Ÿé€šè¿‡`SparkDeskRAGStrategy`ç±»å®ç°ä¸SparkDeskçš„é›†æˆï¼Œè¯¥ç±»ä»…æ”¯æŒæŸ¥è¯¢æ“ä½œï¼Œä¸æ”¯æŒæ–‡æ¡£åˆ‡ç‰‡ã€ä¿å­˜ã€æ›´æ–°å’Œåˆ é™¤ç­‰ç®¡ç†åŠŸèƒ½ã€‚è¿™ç§è®¾è®¡åæ˜ äº†SparkDeskæœåŠ¡çš„å®šä½ï¼Œå³ä½œä¸ºä¸€ä¸ªæŸ¥è¯¢ä¼˜åŒ–çš„çŸ¥è¯†åº“ï¼Œè€Œéå®Œæ•´çš„æ–‡æ¡£ç®¡ç†ç³»ç»Ÿã€‚

```mermaid
classDiagram
class SparkDeskRAGStrategy {
+query(query, doc_ids, repo_ids, top_k, threshold)
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff)
+chunks_save(docId, group, uid, chunks)
+chunks_update(docId, group, uid, chunks)
+chunks_delete(docId, chunkIds)
+query_doc(docId)
+query_doc_name(docId)
}
SparkDeskRAGStrategy --|> RAGStrategy : å®ç°
```

**å›¾è¡¨æ¥æº**
- [sparkdesk_strategy.py](file://core/knowledge/service/impl/sparkdesk_strategy.py)
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py)

### CBG

CBGæ˜¯å¦ä¸€ä¸ªåŸºäºæ˜Ÿç«å¤§æ¨¡å‹çš„çŸ¥è¯†åº“æœåŠ¡ï¼Œæä¾›æ–‡æ¡£ä¸Šä¼ ã€åˆ‡ç‰‡å’Œæ£€ç´¢åŠŸèƒ½ã€‚ç³»ç»Ÿé€šè¿‡`CBGRAGStrategy`ç±»å®ç°ä¸CBGçš„é›†æˆï¼Œè¯¥ç±»æ”¯æŒå®Œæ•´çš„çŸ¥è¯†ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ–‡æ¡£åˆ‡ç‰‡ã€çŸ¥è¯†å—ä¿å­˜ã€æ›´æ–°ã€åˆ é™¤å’ŒæŸ¥è¯¢ã€‚CBGç­–ç•¥çš„å®ç°ä¸å…¶ä»–ç­–ç•¥ç±»ä¼¼ï¼Œä½†å…·ä½“çš„APIè°ƒç”¨å’Œå‚æ•°æ ¼å¼æœ‰æ‰€ä¸åŒã€‚

```mermaid
classDiagram
class CBGRAGStrategy {
+query(query, doc_ids, repo_ids, top_k, threshold)
+split(fileUrl, lengthRange, overlap, resourceType, separator, titleSplit, cutOff)
+chunks_save(docId, group, uid, chunks)
+chunks_update(docId, group, uid, chunks)
+chunks_delete(docId, chunkIds)
+query_doc(docId)
+query_doc_name(docId)
}
CBGRAGStrategy --|> RAGStrategy : å®ç°
```

**å›¾è¡¨æ¥æº**
- [cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py)
- [rag_strategy.py](file://core/knowledge/service/rag_strategy.py)

## ç»Ÿä¸€è®¿é—®æ¥å£è®¾è®¡

ç³»ç»Ÿé€šè¿‡FastAPIæ¡†æ¶æä¾›ç»Ÿä¸€çš„RESTful APIæ¥å£ï¼Œæ‰€æœ‰æ“ä½œéƒ½éµå¾ªä¸€è‡´çš„è¯·æ±‚å’Œå“åº”æ ¼å¼ã€‚æ¥å£è®¾è®¡é‡‡ç”¨è¯·æ±‚æ¨¡å‹ï¼ˆRequest Modelï¼‰æ¨¡å¼ï¼Œé€šè¿‡Pydanticå®šä¹‰ä¸¥æ ¼çš„å‚æ•°éªŒè¯è§„åˆ™ï¼Œç¡®ä¿è¾“å…¥æ•°æ®çš„æ­£ç¡®æ€§ã€‚æ¯ä¸ªAPIç«¯ç‚¹éƒ½é›†æˆäº†åˆ†å¸ƒå¼è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

### APIç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | è¯·æ±‚æ¨¡å‹ |
|------|------|------|----------|
| /knowledge/v1/document/split | POST | æ–‡æ¡£åˆ‡ç‰‡ | FileSplitReq |
| /knowledge/v1/document/upload | POST | æ–‡æ¡£ä¸Šä¼  | - |
| /knowledge/v1/chunks/save | POST | ä¿å­˜çŸ¥è¯†å— | ChunkSaveReq |
| /knowledge/v1/chunk/update | POST | æ›´æ–°çŸ¥è¯†å— | ChunkUpdateReq |
| /knowledge/v1/chunk/delete | POST | åˆ é™¤çŸ¥è¯†å— | ChunkDeleteReq |
| /knowledge/v1/chunk/query | POST | æŸ¥è¯¢çŸ¥è¯†å— | ChunkQueryReq |
| /knowledge/v1/document/chunk | POST | æŸ¥è¯¢æ–‡æ¡£å— | QueryDocReq |
| /knowledge/v1/document/name | POST | æŸ¥è¯¢æ–‡æ¡£åç§° | QueryDocReq |

### è¯·æ±‚æ¨¡å‹

```mermaid
classDiagram
class RAGType {
<<enumeration>>
AIUI-RAG2
CBG-RAG
SparkDesk-RAG
Ragflow-RAG
}
class FileSplitReq {
+file : str
+resourceType : Optional[int]
+ragType : RAGType
+lengthRange : Optional[List[int]]
+overlap : Optional[int]
+separator : Optional[List[str]]
+cutOff : Optional[List[str]]
+titleSplit : Optional[bool]
}
class ChunkSaveReq {
+docId : str
+group : str
+uid : Optional[str]
+chunks : List[Any]
+ragType : RAGType
}
class ChunkUpdateReq {
+docId : str
+group : str
+uid : Optional[str]
+chunks : List[dict]
+ragType : RAGType
}
class ChunkDeleteReq {
+docId : str
+chunkIds : Optional[List[str]]
+ragType : RAGType
}
class ChunkQueryReq {
+query : str
+topN : int
+match : QueryMatch
+ragType : RAGType
}
class QueryMatch {
+docIds : Optional[List[str]]
+repoId : List[str]
+threshold : float
+flowId : Optional[str]
}
class QueryDocReq {
+docId : str
+ragType : RAGType
}
FileSplitReq --> RAGType
ChunkSaveReq --> RAGType
ChunkUpdateReq --> RAGType
ChunkDeleteReq --> RAGType
ChunkQueryReq --> RAGType
ChunkQueryReq --> QueryMatch
```

**å›¾è¡¨æ¥æº**
- [chunk_dto.py](file://core/knowledge/domain/entity/chunk_dto.py)

**ç« èŠ‚æ¥æº**
- [api.py](file://core/knowledge/api/v1/api.py)
- [chunk_dto.py](file://core/knowledge/domain/entity/chunk_dto.py)

## æŸ¥è¯¢è·¯ç”±æœºåˆ¶

ç³»ç»Ÿçš„æŸ¥è¯¢è·¯ç”±æœºåˆ¶åŸºäºå·¥å‚è®¾è®¡æ¨¡å¼å®ç°ï¼Œé€šè¿‡`RAGStrategyFactory`ç±»æ ¹æ®è¯·æ±‚ä¸­çš„`ragType`å‚æ•°åŠ¨æ€åˆ›å»ºç›¸åº”çš„ç­–ç•¥å®ä¾‹ã€‚è¿™ç§è®¾è®¡å®ç°äº†è¯·æ±‚ä¸å…·ä½“å®ç°çš„è§£è€¦ï¼Œä½¿å¾—ç³»ç»Ÿå¯ä»¥è½»æ¾æ‰©å±•æ”¯æŒæ–°çš„çŸ¥è¯†åº“ç±»å‹ã€‚

### è·¯ç”±æµç¨‹

```mermaid
flowchart TD
Start([æ¥æ”¶åˆ°APIè¯·æ±‚]) --> Validate["éªŒè¯è¯·æ±‚å‚æ•°"]
Validate --> CheckRagType{"æ£€æŸ¥ragTypeå‚æ•°"}
CheckRagType --> |æœ‰æ•ˆ| CreateStrategy["åˆ›å»ºç­–ç•¥å®ä¾‹"]
CheckRagType --> |æ— æ•ˆ| ReturnError["è¿”å›é”™è¯¯å“åº”"]
CreateStrategy --> Execute["æ‰§è¡Œå…·ä½“æ“ä½œ"]
Execute --> HandleResult["å¤„ç†ç»“æœå’Œå¼‚å¸¸"]
HandleResult --> ReturnResponse["è¿”å›å“åº”"]
ReturnError --> ReturnResponse
ReturnResponse --> End([ç»“æŸ])
```

### ç­–ç•¥æ³¨å†Œ

ç³»ç»Ÿåœ¨`RAGStrategyFactory`ä¸­é¢„æ³¨å†Œäº†æ‰€æœ‰æ”¯æŒçš„çŸ¥è¯†åº“ç±»å‹ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡`register_strategy`æ–¹æ³•åŠ¨æ€æ³¨å†Œæ–°çš„ç­–ç•¥ã€‚

```python
class RAGStrategyFactory:
    """RAGç­–ç•¥å·¥å‚ï¼Œè´Ÿè´£æ ¹æ®ragTypeåˆ›å»ºç›¸åº”çš„ç­–ç•¥å®ä¾‹ã€‚"""

    _strategies: Dict[str, Type[RAGStrategy]] = {
        "AIUI-RAG2": AIUIRAGStrategy,
        "SparkDesk-RAG": SparkDeskRAGStrategy,
        "CBG-RAG": CBGRAGStrategy,
        "Ragflow-RAG": RagflowRAGStrategy,
    }

    @classmethod
    def get_strategy(cls, ragType: str) -> RAGStrategy:
        """
        æ ¹æ®ragTypeè·å–ç›¸åº”çš„ç­–ç•¥å®ä¾‹ã€‚

        Args:
            ragType: RAGç±»å‹æ ‡è¯†ç¬¦

        Returns:
            å¯¹åº”RAGç­–ç•¥çš„å®ä¾‹

        Raises:
            ValueError: å¦‚æœragTypeä¸æ”¯æŒ
            TypeError: å¦‚æœç­–ç•¥ç±»æ˜¯æŠ½è±¡çš„ï¼Œæ— æ³•å®ä¾‹åŒ–
        """
        strategy_class = cls._strategies.get(ragType)
        if not strategy_class:
            raise ValueError(f"ä¸æ”¯æŒçš„RAGç±»å‹: {ragType}")

        # æ£€æŸ¥ç±»æ˜¯å¦ä¸ºæŠ½è±¡ç±»
        if inspect.isabstract(strategy_class):
            abstract_methods = []
            for name, method in inspect.getmembers(
                strategy_class, predicate=inspect.ismethod
            ):
                if getattr(method, "__isabstractmethod__", False):
                    abstract_methods.append(name)
            raise TypeError(
                f"æ— æ³•å®ä¾‹åŒ–æŠ½è±¡ç±» {strategy_class.__name__} "
                f"åŒ…å«æŠ½è±¡æ–¹æ³•: {', '.join(abstract_methods)}"
            )

        return strategy_class()
```

**ç« èŠ‚æ¥æº**
- [rag_strategy_factory.py](file://core/knowledge/service/rag_strategy_factory.py)
- [api.py](file://core/knowledge/api/v1/api.py)

## æ•°æ®æ ¼å¼ä¸æ£€ç´¢èƒ½åŠ›å·®å¼‚

ä¸åŒçŸ¥è¯†åº“åç«¯åœ¨æ•°æ®æ ¼å¼ã€æ£€ç´¢èƒ½åŠ›å’ŒåŠŸèƒ½æ”¯æŒæ–¹é¢å­˜åœ¨æ˜¾è‘—å·®å¼‚ï¼Œè¿™äº›å·®å¼‚ç›´æ¥å½±å“äº†ç³»ç»Ÿçš„å®ç°æ–¹å¼å’Œç”¨æˆ·çš„é€‰æ‹©ã€‚

### åŠŸèƒ½æ”¯æŒå¯¹æ¯”

| åŠŸèƒ½ | Ragflow | AIUI | SparkDesk | CBG |
|------|---------|------|-----------|-----|
| æ–‡æ¡£åˆ‡ç‰‡ | âœ“ | âœ“ | âœ— | âœ“ |
| çŸ¥è¯†å—ä¿å­˜ | âœ“ | âœ“ | âœ— | âœ“ |
| çŸ¥è¯†å—æ›´æ–° | âœ“ | âœ“ | âœ— | âœ“ |
| çŸ¥è¯†å—åˆ é™¤ | âœ“ | âœ“ | âœ— | âœ“ |
| æ–‡æ¡£æŸ¥è¯¢ | âœ“ | âœ“ | âœ— | âœ“ |
| æ–‡æ¡£åç§°æŸ¥è¯¢ | âœ“ | âœ“ | âœ— | âœ“ |
| å¼‚æ­¥å¤„ç† | âœ“ | âœ“ | âœ“ | âœ“ |
| åˆ†å¸ƒå¼è¿½è¸ª | âœ“ | âœ“ | âœ“ | âœ“ |

### æ•°æ®æ ¼å¼å·®å¼‚

ä¸åŒçŸ¥è¯†åº“åç«¯è¿”å›çš„æ•°æ®æ ¼å¼å­˜åœ¨å·®å¼‚ï¼Œç³»ç»Ÿåœ¨ç­–ç•¥å®ç°ä¸­è¿›è¡Œäº†ç»Ÿä¸€è½¬æ¢ï¼Œç¡®ä¿ä¸Šå±‚åº”ç”¨æ¥æ”¶åˆ°ä¸€è‡´çš„å“åº”æ ¼å¼ã€‚

```mermaid
classDiagram
class ChunkInfo {
+docId : Union[str, int]
+chunkId : Union[int, str]
+content : str
}
class FileInfo {
+docId : Union[str, int]
+fileName : str
+fileStatus : str
+fileQuantity : int
}
class QueryResult {
+query : str
+count : int
+results : List[dict]
}
class ResultItem {
+score : float
+docId : str
+chunkId : str
+fileName : str
+content : str
+context : str
+references : dict
}
QueryResult --> ResultItem
```

**å›¾è¡¨æ¥æº**
- [rag_do.py](file://core/knowledge/domain/entity/rag_do.py)

**ç« èŠ‚æ¥æº**
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py)
- [aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py)
- [sparkdesk_strategy.py](file://core/knowledge/service/impl/sparkdesk_strategy.py)
- [cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py)

## è·¨çŸ¥è¯†åº“è”åˆæŸ¥è¯¢

è™½ç„¶å½“å‰ç³»ç»Ÿè®¾è®¡ä¸»è¦æ”¯æŒå•ä¸€çŸ¥è¯†åº“çš„æŸ¥è¯¢æ“ä½œï¼Œä½†é€šè¿‡ä¸Šå±‚åº”ç”¨çš„åè°ƒï¼Œå¯ä»¥å®ç°è·¨çŸ¥è¯†åº“çš„è”åˆæŸ¥è¯¢ã€‚ç³»ç»Ÿæä¾›äº†ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£ï¼Œä¸Šå±‚åº”ç”¨å¯ä»¥å¹¶è¡Œè°ƒç”¨å¤šä¸ªçŸ¥è¯†åº“çš„æŸ¥è¯¢æ¥å£ï¼Œç„¶åå¯¹ç»“æœè¿›è¡Œåˆå¹¶å’Œæ’åºã€‚

### è”åˆæŸ¥è¯¢å®ç°æ–¹æ¡ˆ

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant App as "ä¸Šå±‚åº”ç”¨"
participant Ragflow as "Ragflow"
participant AIUI as "AIUI"
participant CBG as "CBG"
Client->>App : å‘èµ·è”åˆæŸ¥è¯¢è¯·æ±‚
App->>Ragflow : å¹¶è¡ŒæŸ¥è¯¢Ragflow
App->>AIUI : å¹¶è¡ŒæŸ¥è¯¢AIUI
App->>CBG : å¹¶è¡ŒæŸ¥è¯¢CBG
Ragflow-->>App : è¿”å›Ragflowç»“æœ
AIUI-->>App : è¿”å›AIUIç»“æœ
CBG-->>App : è¿”å›CBGç»“æœ
App->>App : åˆå¹¶å’Œæ’åºç»“æœ
App-->>Client : è¿”å›è”åˆæŸ¥è¯¢ç»“æœ
```

### ä½¿ç”¨ç¤ºä¾‹

```python
async def federated_query(query: str, top_k: int = 5):
    """
    è·¨çŸ¥è¯†åº“è”åˆæŸ¥è¯¢ç¤ºä¾‹
    
    Args:
        query: æŸ¥è¯¢æ–‡æœ¬
        top_k: è¿”å›ç»“æœæ•°é‡
    
    Returns:
        åˆå¹¶åçš„æŸ¥è¯¢ç»“æœ
    """
    # å¹¶è¡Œå‘èµ·å¤šä¸ªæŸ¥è¯¢è¯·æ±‚
    ragflow_task = ragflow_strategy.query(query, top_k=top_k)
    aiui_task = aiui_strategy.query(query, top_k=top_k)
    cbg_task = cbg_strategy.query(query, top_k=top_k)
    
    # ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ
    ragflow_results, aiui_results, cbg_results = await asyncio.gather(
        ragflow_task, aiui_task, cbg_task
    )
    
    # åˆå¹¶ç»“æœ
    all_results = []
    all_results.extend(ragflow_results["results"])
    all_results.extend(aiui_results["results"])
    all_results.extend(cbg_results["results"])
    
    # æŒ‰ç›¸ä¼¼åº¦æ’åº
    sorted_results = sorted(all_results, key=lambda x: x.get("score", 0), reverse=True)
    
    # è¿”å›å‰top_kä¸ªç»“æœ
    return {
        "query": query,
        "count": len(sorted_results[:top_k]),
        "results": sorted_results[:top_k]
    }
```

**ç« èŠ‚æ¥æº**
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py)
- [aiui_strategy.py](file://core/knowledge/service/impl/aiui_strategy.py)
- [cbg_strategy.py](file://core/knowledge/service/impl/cbg_strategy.py)

## è¿ç»´åŠŸèƒ½

ç³»ç»Ÿé›†æˆäº†å®Œæ•´çš„è¿ç»´åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ•°æ®åŒæ­¥ã€å…ƒæ•°æ®ç®¡ç†ã€å¥åº·æ£€æŸ¥ç­‰ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œå¯ç»´æŠ¤æ€§ã€‚

### æ•°æ®åŒæ­¥

ç³»ç»Ÿé€šè¿‡å¼‚æ­¥ä»»åŠ¡å’Œäº‹ä»¶é©±åŠ¨æœºåˆ¶å®ç°æ•°æ®åŒæ­¥ã€‚å½“æ–‡æ¡£ä¸Šä¼ æˆ–æ›´æ–°æ—¶ï¼Œç³»ç»Ÿä¼šè§¦å‘ç›¸åº”çš„è§£æå’Œç´¢å¼•ä»»åŠ¡ï¼Œç¡®ä¿çŸ¥è¯†åº“ä¸­çš„æ•°æ®ä¸æºæ–‡æ¡£ä¿æŒåŒæ­¥ã€‚

```mermaid
flowchart TD
Start([æ–‡æ¡£ä¸Šä¼ ]) --> Upload["ä¸Šä¼ åˆ°çŸ¥è¯†åº“"]
Upload --> Trigger["è§¦å‘è§£æä»»åŠ¡"]
Trigger --> Parse["å¼‚æ­¥è§£ææ–‡æ¡£"]
Parse --> Index["æ„å»ºç´¢å¼•"]
Index --> Notify["é€šçŸ¥åŒæ­¥å®Œæˆ"]
Notify --> End([åŒæ­¥å®Œæˆ])
```

### å…ƒæ•°æ®ç®¡ç†

ç³»ç»Ÿé€šè¿‡`FileInfo`å’Œ`ChunkInfo`ç±»ç®¡ç†æ–‡æ¡£å’ŒçŸ¥è¯†å—çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ–‡æ¡£IDã€æ–‡ä»¶åã€çŠ¶æ€ã€æ•°é‡ç­‰ä¿¡æ¯ã€‚è¿™äº›å…ƒæ•°æ®ç”¨äºæ–‡æ¡£ç®¡ç†å’ŒæŸ¥è¯¢ä¼˜åŒ–ã€‚

```python
class FileInfo:
    """ç±»è¡¨ç¤ºæ–‡ä»¶ä¿¡æ¯"""

    def __init__(
        self,
        docId: Union[str, int],
        fileName: str,
        fileStatus: str = "",
        fileQuantity: int = 0,
    ) -> None:
        """
        åˆå§‹åŒ–FileInfoå®ä¾‹

        Args:
            docId: æ–‡æ¡£æ ‡è¯†ç¬¦
            fileName: æ–‡ä»¶å
            fileStatus: æ–‡ä»¶çŠ¶æ€
            fileQuantity: æ–‡ä»¶æ•°é‡
        """
        self.docId = docId
        self.fileName = fileName
        self.fileStatus = fileStatus
        self.fileQuantity = fileQuantity
```

### å¥åº·æ£€æŸ¥

ç³»ç»Ÿåœ¨`main.py`ä¸­å®ç°äº†æœåŠ¡å¯åŠ¨å’Œå…³é—­çš„é’©å­å‡½æ•°ï¼Œç”¨äºæ‰“å°è·¯ç”±ä¿¡æ¯å’Œæ¸…ç†ä¼šè¯èµ„æºï¼Œç¡®ä¿æœåŠ¡çš„å¥åº·è¿è¡Œã€‚

```python
@app.on_event("startup")
async def print_routes() -> None:
    """æ‰“å°æ³¨å†Œçš„è·¯ç”±ä¿¡æ¯"""
    route_infos = []
    for route in app.routes:
        route_infos.append(
            {
                "path": getattr(route, "path", str(route)),
                "name": getattr(route, "name", type(route).__name__),
                "methods": (
                    list(route.methods) if hasattr(route, "methods") else "chat"
                ),
            }
        )
    logger.info("æ³¨å†Œçš„è·¯ç”±:")
    print("æ³¨å†Œçš„è·¯ç”±:")
    for route_info in route_infos:
        logger.info(json.dumps(route_info, ensure_ascii=False))
        print(json.dumps(route_info, ensure_ascii=False))

@app.on_event("shutdown")
async def shutdown() -> None:
    """æœåŠ¡å…³é—­æ—¶çš„æ¸…ç†å·¥ä½œ"""
    try:
        from knowledge.infra.ragflow import cleanup_session
        await cleanup_session()
    except Exception as e:
        logger.warning(f"æ¸…ç†RAGFlowä¼šè¯å¤±è´¥: {e}")
    print("ğŸ§¹ æœ€ç»ˆçš„å…³é—­é’©å­å·²æ‰§è¡Œã€‚")
```

**ç« èŠ‚æ¥æº**
- [main.py](file://core/knowledge/main.py)
- [rag_do.py](file://core/knowledge/domain/entity/rag_do.py)
- [ragflow_strategy.py](file://core/knowledge/service/impl/ragflow_strategy.py)

## è¿ç§»æŒ‡å—

æœ¬æŒ‡å—æä¾›å°†ç°æœ‰çŸ¥è¯†åº“è¿ç§»åˆ°æœ¬å¹³å°çš„è¯¦ç»†æ­¥éª¤ï¼Œå¸®åŠ©ç”¨æˆ·é¡ºåˆ©å®Œæˆè¿ç§»å·¥ä½œã€‚

### è¿ç§»å‡†å¤‡

1. **ç¯å¢ƒå‡†å¤‡**ï¼šç¡®ä¿ç›®æ ‡ç¯å¢ƒå·²æ­£ç¡®é…ç½®ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€ç¼“å­˜ã€å¯¹è±¡å­˜å‚¨ç­‰ä¾èµ–æœåŠ¡ã€‚
2. **é…ç½®æ£€æŸ¥**ï¼šæ ¸å¯¹`config.env`æ–‡ä»¶ä¸­çš„é…ç½®é¡¹ï¼Œç¡®ä¿æ‰€æœ‰å¿…è¦çš„ç¯å¢ƒå˜é‡éƒ½å·²æ­£ç¡®è®¾ç½®ã€‚
3. **æƒé™éªŒè¯**ï¼šç¡®è®¤æœåŠ¡è´¦æˆ·å…·æœ‰è®¿é—®å„ä¸ªçŸ¥è¯†åº“åç«¯çš„å¿…è¦æƒé™ã€‚

### è¿ç§»æ­¥éª¤

1. **æ•°æ®å¯¼å‡º**ï¼šä»æºçŸ¥è¯†åº“å¯¼å‡ºæ‰€æœ‰æ–‡æ¡£å’Œå…ƒæ•°æ®ã€‚
2. **æ•°æ®è½¬æ¢**ï¼šå°†å¯¼å‡ºçš„æ•°æ®è½¬æ¢ä¸ºæœ¬å¹³å°æ”¯æŒçš„æ ¼å¼ã€‚
3. **æ•°æ®å¯¼å…¥**ï¼šä½¿ç”¨æœ¬å¹³å°çš„APIæ¥å£æ‰¹é‡å¯¼å…¥æ•°æ®ã€‚
4. **éªŒè¯æµ‹è¯•**ï¼šå¯¹å¯¼å…¥çš„æ•°æ®è¿›è¡ŒæŸ¥è¯¢å’ŒåŠŸèƒ½æµ‹è¯•ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’ŒåŠŸèƒ½æ­£ç¡®æ€§ã€‚

### è¿ç§»ç¤ºä¾‹

```python
async def migrate_from_source(source_data: List[Dict]):
    """
    ä»æºçŸ¥è¯†åº“è¿ç§»æ•°æ®çš„ç¤ºä¾‹
    
    Args:
        source_data: æºçŸ¥è¯†åº“æ•°æ®åˆ—è¡¨
    """
    for item in source_data:
        # åˆ›å»ºæ–‡æ¡£åˆ‡ç‰‡è¯·æ±‚
        split_req = FileSplitReq(
            file=item["file_url"],
            ragType=RAGType.Ragflow_RAG,
            lengthRange=[256, 1024],
            separator=["ã€‚", "ï¼", "ï¼›", "ï¼Ÿ"]
        )
        
        # è°ƒç”¨æ–‡æ¡£åˆ‡ç‰‡API
        split_result = await file_split(split_req)
        
        if split_result.data:
            # ä¿å­˜çŸ¥è¯†å—
            save_req = ChunkSaveReq(
                docId=split_result.data[0]["docId"],
                group="è¿ç§»æ•°æ®",
                chunks=split_result.data,
                ragType=RAGType.Ragflow_RAG
            )
            await chunk_save(save_req)
```

**ç« èŠ‚æ¥æº**
- [api.py](file://core/knowledge/api/v1/api.py)
- [chunk_dto.py](file://core/knowledge/domain/entity/chunk_dto.py)