# 贡献指南

<cite>
**本文档引用的文件**
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md)
- [Makefile](file://Makefile)
- [makefiles/localci.toml](file://makefiles/localci.toml)
- [console/frontend/.prettierrc](file://console/frontend/.prettierrc)
- [console/frontend/eslint.config.js](file://console/frontend/eslint.config.js)
- [console/backend/config/checkstyle.xml](file://console/backend/config/checkstyle.xml)
- [console/backend/config/eclipse-formatter.xml](file://console/backend/config/eclipse-formatter.xml)
- [console/frontend/package.json](file://console/frontend/package.json)
- [core/agent/.flake8](file://core/agent/.flake8)
- [core/agent/pyproject.toml](file://core/agent/pyproject.toml)
</cite>

## 目录

1. [代码提交规范](#代码提交规范)
2. [代码风格标准与自动化格式化](#代码风格标准与自动化格式化)
3. [代码审查关键检查点](#代码审查关键检查点)
4. [问题报告与功能建议](#问题报告与功能建议)
5. [文档更新与版本发布](#文档更新与版本发布)

## 代码提交规范

### 分支命名规范

项目采用基于功能的分支命名约定，确保分支目的清晰可识别。所有分支名称必须使用小写字母和连字符分隔。

| 分支类型 | 命名格式 | 示例 | 用途 |
|---------|--------|------|------|
| 功能分支 | `feature/功能名` | `feature/user-authentication` | 开发新功能 |
| 修复分支 | `bugfix/问题名` | `bugfix/login-timeout` | 修复已知缺陷 |
| 紧急修复分支 | `hotfix/补丁名` | `hotfix/security-vulnerability` | 生产环境紧急修复 |
| 文档分支 | `doc/文档名` | `doc/api-guide` | 文档更新 |

使用Makefile命令创建分支以确保一致性：
```bash
# 创建功能分支
make new-feature name=user-authentication

# 创建修复分支
make new-bugfix name=login-timeout

# 创建紧急修复分支
make new-hotfix name=security-vulnerability
```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L100-L130)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L100-L130)

### 提交信息格式

遵循Conventional Commits规范，确保提交信息结构化、可解析。

**提交信息格式：**
```
<类型>(<范围>): <描述>

[可选正文]

[可选页脚]
```

**类型说明：**
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式化（不影响逻辑）
- `refactor`: 代码重构（非功能变更）
- `test`: 测试相关变更
- `chore`: 构建工具或依赖更新

**范围说明：**
指定变更影响的模块或组件，如`auth`、`api`、`frontend`等。

**示例：**
```bash
feat(auth): 添加OAuth2认证支持
fix(api): 修复用户信息查询接口
docs(guide): 完善快速开始指南
style(frontend): 格式化组件样式
refactor(core): 重构工作流引擎
```

**提交前检查清单：**
- [ ] 代码已格式化 (`make format`)
- [ ] 质量检查通过 (`make check`)
- [ ] 测试通过 (`make test`)
- [ ] 分支命名遵循约定
- [ ] 提交信息遵循格式
- [ ] 文档已更新（如需要）

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L350-L400)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L350-L400)

### Pull Request流程

#### PR创建前准备

在提交Pull Request前，确保完成以下步骤：

1. **Fork仓库并创建特性分支**
   ```bash
   git clone https://github.com/your-username/astron-agent.git
   cd astron-agent
   git remote add upstream https://github.com/iflytek/astron-agent.git
   make new-feature name=your-feature
   ```

2. **开发并测试**
   - 遵循编码标准
   - 为新功能添加测试
   - 更新相关文档
   - 在本地通过所有质量检查

3. **同步主分支**
   ```bash
   git fetch upstream
   git rebase upstream/main
   ```

#### PR描述模板

使用以下模板填写PR描述，确保信息完整：

```markdown
## 描述
变更的简要描述

## 变更类型
- [ ] Bug修复
- [ ] 新功能
- [ ] 破坏性变更
- [ ] 文档更新

## 测试
- [ ] 单元测试已添加/更新
- [ ] 集成测试已添加/更新
- [ ] 手动测试已完成

## 检查清单
- [ ] 代码遵循项目风格指南
- [ ] 已完成自我审查
- [ ] 文档已更新
- [ ] 无破坏性变更（或已记录）
```

#### PR审查流程

1. **自动化检查**：所有PR必须通过CI/CD流水线的自动化质量检查
2. **代码审查**：至少一位项目维护者必须批准
3. **测试验证**：所有测试用例必须通过
4. **文档确认**：如有API或功能变更，文档必须同步更新

合并后，贡献者将被记录在发布说明和贡献者列表中。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L450-L550)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L450-L550)

## 代码风格标准与自动化格式化

### 多语言代码质量标准

项目采用统一的质量标准，支持多种编程语言，确保代码一致性。

| 语言 | 格式化工具 | 质量检查工具 | 核心标准 |
|------|------------|--------------|---------|
| **Go** | gofmt, goimports, gofumpt | golangci-lint, staticcheck | Go标准格式，圈复杂度≤10 |
| **Java** | Spotless (Google Java Format) | Checkstyle, PMD, SpotBugs | Google Java风格，圈复杂度≤10 |
| **Python** | black, isort | flake8, mypy, pylint | PEP 8，圈复杂度≤10 |
| **TypeScript** | prettier | eslint, tsc | ESLint规则，严格类型检查 |

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L250-L280)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L250-L280)

### 自动化格式化工具配置

#### TypeScript/JavaScript (前端)

前端项目使用Prettier进行代码格式化，配置文件位于`console/frontend/.prettierrc`：

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false,
  "bracketSpacing": true,
  "arrowParens": "avoid",
  "endOfLine": "lf"
}
```

ESLint配置位于`console/frontend/eslint.config.js`，集成Prettier和TypeScript检查：
- 使用`@typescript-eslint/eslint-plugin`进行类型检查
- 集成`eslint-plugin-prettier`确保格式一致性
- 关键规则：`no-explicit-any`（警告）、`complexity`（警告，阈值40）、`max-lines-per-function`（警告，阈值200）

**Section sources**
- [console/frontend/.prettierrc](file://console/frontend/.prettierrc)
- [console/frontend/eslint.config.js](file://console/frontend/eslint.config.js)

#### Java (后端)

后端Java服务使用Google Java Format进行代码格式化，配置文件位于`console/backend/config/eclipse-formatter.xml`。

关键格式化规则：
- 行长度限制：240字符
- 方法长度限制：100行
- 参数数量限制：10个
- 圈复杂度限制：20

Checkstyle配置位于`console/backend/config/checkstyle.xml`，确保代码质量。

**Section sources**
- [console/backend/config/checkstyle.xml](file://console/backend/config/checkstyle.xml)
- [console/backend/config/eclipse-formatter.xml](file://console/backend/config/eclipse-formatter.xml)

#### Python (核心服务)

Python服务使用flake8进行代码质量检查，配置文件位于各Python模块的`.flake8`文件中。

核心质量要求：
- 遵循PEP 8编码规范
- 类型检查通过mypy
- 圈复杂度≤10
- 代码覆盖率不降低

pyproject.toml文件定义了依赖和构建配置。

**Section sources**
- [core/agent/.flake8](file://core/agent/.flake8)
- [core/agent/pyproject.toml](file://core/agent/pyproject.toml)

### 质量检查命令

使用Makefile提供的统一命令进行质量检查：

```bash
# 检查所有语言
make check

# 检查特定语言
make check-go
make check-java
make check-python
make check-typescript

# 格式化所有代码
make format

# 运行所有测试
make test

# 安全推送（包含预检查）
make safe-push
```

**Section sources**
- [Makefile](file://Makefile)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L300-L330)

## 代码审查关键检查点

代码审查应重点关注以下方面，确保代码质量和系统稳定性。

### 安全性检查

1. **输入验证**：所有用户输入必须经过验证和清理
2. **身份验证**：敏感操作必须进行身份验证和权限检查
3. **数据保护**：敏感数据（如密码、密钥）不得硬编码或明文存储
4. **依赖安全**：第三方依赖应定期更新，避免已知漏洞

### 性能检查

1. **算法复杂度**：避免O(n²)及以上复杂度的算法
2. **数据库查询**：避免N+1查询问题，合理使用索引
3. **内存使用**：避免内存泄漏，及时释放资源
4. **异步处理**：耗时操作应异步执行，避免阻塞主线程

### 可维护性检查

1. **代码可读性**：变量和函数命名清晰，代码结构合理
2. **注释质量**：关键逻辑和复杂算法应有适当注释
3. **单元测试**：核心功能应有充分的单元测试覆盖
4. **错误处理**：异常情况应有适当的错误处理和日志记录

### 架构一致性

1. **设计模式**：遵循项目已有的设计模式和架构约定
2. **接口设计**：API设计应简洁、一致，遵循RESTful原则
3. **依赖管理**：避免循环依赖，合理划分模块边界
4. **配置管理**：环境相关配置应通过配置文件或环境变量管理

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L450-L550)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L450-L550)

## 问题报告与功能建议

### 报告Bug

报告Bug时，请提供完整的信息以便快速复现和修复：

1. **问题描述**：清晰描述遇到的问题
2. **复现步骤**：详细说明如何复现问题
3. **预期行为**：说明期望的结果
4. **实际行为**：描述实际发生的情况
5. **环境信息**：操作系统、浏览器、版本等
6. **日志信息**：相关错误日志或堆栈跟踪
7. **截图**：如有界面问题，请提供截图

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L500-L520)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L500-L520)

### 提出新功能建议

提出新功能时，请包含以下信息：

1. **功能描述**：清晰描述新功能
2. **使用场景**：说明功能的使用场景和用户需求
3. **解决方案**：建议的实现方案或技术选型
4. **替代方案**：考虑过的其他方案及优缺点
5. **相关参考**：类似功能的参考实现或设计

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L520-L540)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L520-L540)

### 参与技术讨论

参与技术讨论时，请遵循以下原则：

1. **尊重他人**：保持专业和尊重的态度
2. **提供依据**：技术决策应有合理的依据和数据支持
3. **开放心态**：接受不同意见，共同寻找最佳方案
4. **明确结论**：讨论后应有明确的结论和后续行动

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L600-L620)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L600-L620)

## 文档更新与版本发布

### 文档更新要求

代码变更时，相关文档必须同步更新：

1. **README更新**：重大变更需更新README文件
2. **API文档**：新增或修改的API需更新文档
3. **安装指南**：环境配置或安装步骤变更需更新指南
4. **故障排除**：常见问题和解决方案应记录在文档中

文档位于`docs/`目录，使用Markdown格式编写。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L380-L400)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L380-L400)

### 版本发布流程

项目遵循语义化版本控制（SemVer）：

- **主版本号**：包含破坏性变更
- **次版本号**：包含新功能（向后兼容）
- **补丁版本号**：包含Bug修复（向后兼容）

**发布工作流：**

1. **创建发布分支**：从main分支创建发布分支
2. **更新版本号**：修改版本号和变更日志
3. **完整测试**：运行完整的测试套件
4. **发布PR**：创建发布PR供审查
5. **合并与标记**：审查通过后合并并打标签
6. **生产部署**：部署到生产环境

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L550-L580)
- [CONTRIBUTING_CN.md](file://CONTRIBUTING_CN.md#L550-L580)