# 国际化

<cite>
**本文档引用的文件**
- [index.ts](file://console/frontend/src/i18n/index.ts)
- [localeConfig.ts](file://console/frontend/src/locales/localeConfig.ts)
- [README.md](file://console/frontend/src/locales/README.md)
- [zh.js](file://console/frontend/src/locales/zh.js)
- [en.js](file://console/frontend/src/locales/en.js)
- [index.tsx](file://console/frontend/src/components/language-switcher/index.tsx)
- [locale-store.ts](file://console/frontend/src/store/spark-store/locale-store.ts)
- [zh-ZH/index.ts](file://console/frontend/src/locales/zh-ZH/index.ts)
- [en-En/index.ts](file://console/frontend/src/locales/en-En/index.ts)
</cite>

## 目录
1. [简介](#简介)
2. [语言包组织结构](#语言包组织结构)
3. [i18n实例初始化与配置](#i18n实例初始化与配置)
4. [语言切换机制](#语言切换机制)
5. [在组件中使用翻译函数](#在组件中使用翻译函数)
6. [实际代码示例](#实际代码示例)

## 简介

本项目采用 `react-i18next` 实现国际化功能，支持中文 (zh) 和英文 (en) 两种语言。国际化系统通过模块化的方式组织翻译资源，实现了高效的多语言支持。

**Section sources**
- [README.md](file://console/frontend/src/locales/README.md)

## 语言包组织结构

项目的语言包位于 `src/locales` 目录下，采用了分层的组织结构：

- `en-En/` 和 `zh-ZH/` 目录分别存放英文和中文的翻译文件
- 每个语言目录下包含多个模块化的翻译文件，如 `workflow.ts`、`common.ts`、`model.ts` 等
- `en.js` 和 `zh.js` 文件作为入口文件，导入并导出对应语言的所有翻译资源

翻译键采用点号分隔的层级结构，例如 `workflow.nodes.common.selectPlaceholder`，这种结构有助于组织和查找翻译文本。系统还实现了翻译键的复用机制，将通用的翻译文本（如"添加"、"取消"、"确定"等）放在 `common` 键下，供所有组件共享使用，避免了重复定义。

**Section sources**
- [README.md](file://console/frontend/src/locales/README.md)
- [zh-ZH/index.ts](file://console/frontend/src/locales/zh-ZH/index.ts)
- [en-En/index.ts](file://console/frontend/src/locales/en-En/index.ts)

## i18n实例初始化与配置

i18n实例在 `src/i18n/index.ts` 文件中进行初始化和配置。系统使用 `i18next` 作为核心库，并结合 `react-i18next` 使其与React框架无缝集成。

初始化过程包括：
1. 导入 `i18next`、`react-i18next` 和 `i18next-browser-languagedetector` 等必要的模块
2. 创建 `getSavedLanguage` 函数，从 `localStorage` 中读取用户之前选择的语言偏好
3. 使用 `.use()` 方法注册语言检测器和React集成插件
4. 调用 `.init()` 方法进行详细配置

配置选项包括：
- `resources`: 定义了所有可用的语言资源，将 `zh` 和 `en` 映射到对应的翻译对象
- `fallbackLng`: 设置默认语言为中文 (`zh`)
- `interpolation`: 配置插值选项，设置 `escapeValue: false` 因为React已经提供了XSS防护
- `detection`: 配置语言检测策略，按顺序从 `localStorage` 和浏览器语言设置中检测
- `lng`: 设置初始语言，优先使用用户保存的语言选择，否则使用默认语言
- `load`: 设置为 `languageOnly` 确保只加载语言代码（如 `zh`、`en`），而不加载地区代码（如 `zh-CN`、`en-US`）

**Section sources**
- [index.ts](file://console/frontend/src/i18n/index.ts)

## 语言切换机制

项目实现了完整的语言切换机制，允许用户在中文和英文之间自由切换。

语言切换的核心逻辑位于 `src/components/language-switcher/index.tsx` 组件中。该组件渲染一个带有地球图标的按钮，显示当前语言的缩写（"EN" 或 "ZH"）。当用户点击按钮时，会触发 `toggleLanguage` 函数：

1. 检测当前语言，如果以 `zh` 开头则切换到英文，否则切换到中文
2. 调用 `i18n.changeLanguage()` 方法更新i18n实例的语言设置
3. 将新的语言选择保存到 `localStorage` 的两个键中：`locale-storage` 和 `locale`
4. 设置一个短暂的延迟（100毫秒）后刷新页面，确保语言设置已完全保存

此外，项目还使用Zustand状态管理库创建了 `locale-store`，用于在应用状态中跟踪当前语言。`useLocaleStore` hook提供了 `setLocale` 和 `toggleLocale` 方法，确保语言状态在应用的各个部分保持同步。`getSimpleLanguage` 函数确保所有中文变体（如 `zh-CN`、`zh-TW`）都被统一为简单的 `zh` 代码。

**Section sources**
- [index.tsx](file://console/frontend/src/components/language-switcher/index.tsx)
- [locale-store.ts](file://console/frontend/src/store/spark-store/locale-store.ts)

## 在组件中使用翻译函数

在React组件中使用翻译功能非常简单。组件需要从 `react-i18next` 导入 `useTranslation` hook，然后调用它获取翻译函数 `t`。

基本用法如下：
```typescript
const { t } = useTranslation();
return <div>{t('keyName')}</div>;
```

对于需要动态参数的翻译文本，可以在调用 `t` 函数时传递一个对象作为第二个参数：
```typescript
const { t } = useTranslation();
const currentDate = dayjs();
return <div>{t('myMessage', { ts: currentDate })}</div>;
```

在翻译文件中，可以使用 `{parameterName}` 语法来引用这些动态参数。项目还提供了 `localeConfig` 文件，导出了所有语言的配置对象，方便在需要直接访问翻译资源的场景下使用。

**Section sources**
- [README.md](file://console/frontend/src/locales/README.md)
- [localeConfig.ts](file://console/frontend/src/locales/localeConfig.ts)

## 实际代码示例

以下是一个实际的代码示例，展示了如何在组件中实现国际化：

```typescript
import React from 'react';
import { Button } from 'antd';
import { GlobalOutlined } from '@ant-design/icons';
import { useTranslation } from 'react-i18next';

const LanguageSwitcher: React.FC = () => {
  const { i18n } = useTranslation();
  const currentLanguage = i18n.language;

  const toggleLanguage = () => {
    const newLang = currentLanguage.startsWith('zh') ? 'en' : 'zh';
    i18n.changeLanguage(newLang);
    localStorage.setItem('locale-storage', newLang);
    localStorage.setItem('locale', newLang);

    setTimeout(() => {
      window.location.reload();
    }, 100);
  };

  return (
    <Button
      type="text"
      icon={<GlobalOutlined />}
      onClick={toggleLanguage}
    >
      {currentLanguage.startsWith('zh') ? 'EN' : 'ZH'}
    </Button>
  );
};

export default LanguageSwitcher;
```

这个语言切换器组件展示了国际化实现的关键要素：使用 `useTranslation` hook 获取i18n实例，根据当前语言状态显示相应的文本，并在语言切换时更新全局状态和持久化存储。

**Section sources**
- [index.tsx](file://console/frontend/src/components/language-switcher/index.tsx)